import{_ as Q}from"./_plugin-vue_export-helper-383fd9f4.js";/* empty css                        *//* empty css                    */import"./el-tooltip-4ed993c7.js";/* empty css                  *//* empty css               *//* empty css               *//* empty css                *//* empty css                 *//* empty css                  *//* empty css                  *//* empty css                             */import{r as g,b as z,o as q,a4 as B,c as D,d as I,f as t,w as e,a5 as G,a6 as J,F as K,y as W,z as X,j as x,e as o,N as w,t as h,ap as Z,m as $,n as tt,p as at,E as et,h as ot,Q as st,a7 as lt,ak as nt,al as rt,aa as dt,aM as it,ab as ct,aH as pt}from"./index-edaa0abb.js";import{i as C}from"./index-18acf776.js";import{getReservationStatsApi as N,getReservationCalendarApi as _t}from"./reservation-687ea777.js";import{getLabsApi as ut}from"./lab-b5105c5b.js";const mt={class:"reservation-statistics"},ft={class:"stat-content"},bt={class:"stat-icon total-icon"},vt={class:"stat-info"},yt={class:"stat-number"},gt={class:"stat-content"},ht={class:"stat-icon approved-icon"},Rt={class:"stat-info"},xt={class:"stat-number"},wt={class:"stat-content"},Ct={class:"stat-icon pending-icon"},kt={class:"stat-info"},Dt={class:"stat-number"},Et={class:"stat-content"},Yt={class:"stat-icon rate-icon"},At={class:"stat-info"},St={class:"stat-number"},Ft={__name:"Reservation",setup(jt){const E=g(),Y=g(),A=g(),S=g(),F=g([]),j=g([]),l=z({dateRange:[],lab_id:null,status:null}),d=z({total:0,approved:0,pending:0,rejected:0,completed:0,approvalRate:0}),H=async()=>{try{const n=await ut({page:1,page_size:100});F.value=n.code===200?n.data.list||[]:[]}catch(n){console.error("加载实验室列表失败:",n)}},V=async()=>{var n;try{const a={};l.lab_id&&(a.laboratory_id=l.lab_id),l.status&&(a.status=l.status),((n=l.dateRange)==null?void 0:n.length)===2&&(a.date_from=l.dateRange[0],a.date_to=l.dateRange[1]);const r=await N(a);if(r.code===200){const s=r.data.status_distribution||{};d.total=r.data.total_reservations||0,d.approved=s.confirmed||0,d.pending=s.pending||0,d.rejected=s.cancelled||0,d.completed=s.completed||0,d.approvalRate=d.total>0?(d.approved/d.total*100).toFixed(1):0,k(r.data.daily_trend||r.data.by_date||[]),P(r.data.laboratory_distribution||r.data.by_laboratory||[])}}catch(a){console.error("加载预约统计失败:",a)}},M=async()=>{var n;try{const a={};l.lab_id&&(a.laboratory_id=l.lab_id),((n=l.dateRange)==null?void 0:n.length)===2&&(a.date_from=l.dateRange[0],a.date_to=l.dateRange[1]);const r=await N(a);if(r.code===200){const s=r.data.status_distribution||{},_=r.data.by_laboratory||r.data.laboratory_distribution||[];j.value=_.map(u=>{const f=u.reservation_count||u.count||0,y=s.confirmed||0,c=s.pending||0,b=s.cancelled||0,p=s.completed||0,v=f>0?Number((y/f*100).toFixed(1)):0;return{lab_name:u.laboratory_name,total_reservations:f,approved_count:y,pending_count:c,rejected_count:b,completed_count:p,approval_rate:v,utilization_rate:0}})}}catch(a){console.error("加载详细统计失败:",a)}},T=()=>{const n=C(E.value),a={tooltip:{trigger:"item",formatter:"{a} <br/>{b}: {c} ({d}%)"},series:[{name:"预约状态",type:"pie",radius:"60%",data:[{value:d.approved,name:"已批准"},{value:d.pending,name:"待审核"},{value:d.rejected,name:"已拒绝"},{value:d.completed,name:"已完成"}],itemStyle:{color:function(r){return["#67C23A","#E6A23C","#F56C6C","#409EFF"][r.dataIndex]}}}]};n.setOption(a)},k=n=>{const a=C(Y.value),r={tooltip:{trigger:"axis"},xAxis:{type:"category",data:(n||[]).map(s=>s.date)},yAxis:{type:"value"},series:[{data:(n||[]).map(s=>s.count),type:"line",smooth:!0,itemStyle:{color:"#409EFF"},areaStyle:{color:"rgba(64, 158, 255, 0.2)"}}]};a.setOption(r)},P=n=>{const a=C(A.value),r={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},xAxis:{type:"value"},yAxis:{type:"category",data:(n||[]).map(s=>s.laboratory_name)},series:[{data:(n||[]).map(s=>s.reservation_count||s.count),type:"bar",itemStyle:{color:"#67C23A"}}]};a.setOption(r)},L=async()=>{var b,p;const n=new Date,a=((b=l.dateRange)==null?void 0:b[0])||dayjs(n).subtract(7,"day").format("YYYY-MM-DD"),r=((p=l.dateRange)==null?void 0:p[1])||dayjs(n).format("YYYY-MM-DD"),s={start_date:a,end_date:r};l.lab_id&&(s.laboratory_id=l.lab_id),l.status&&(s.status=l.status);const _=await _t(s),u=["08:00","10:00","12:00","14:00","16:00","18:00","20:00"],f=new Array(u.length).fill(0);if(_.code===200)for(const v of _.data||[]){const m=dayjs(v.start_time).format("HH:mm"),R=u.findIndex(i=>m<=i);R>=0&&(f[R]+=1)}const y=C(S.value),c={tooltip:{trigger:"axis"},xAxis:{type:"category",data:u.map(v=>v.replace(":",":"))},yAxis:{type:"value"},series:[{data:f,type:"bar",itemStyle:{color:"#E6A23C"}}]};y.setOption(c)},O=async()=>{await V(),await M(),B(()=>{T(),k(),initLabRankingChart(),L()})},U=()=>{Object.assign(l,{dateRange:[],lab_id:null,status:null}),O()};return q(async()=>{await H(),await V(),await M(),B(()=>{T(),k(),initLabRankingChart(),L()})}),(n,a)=>{const r=Z,s=$,_=tt,u=at,f=et,y=ot,c=G,b=st,p=lt,v=J,m=nt,R=rt;return D(),I("div",mt,[t(c,{class:"filter-card"},{default:e(()=>[t(y,{model:l,inline:""},{default:e(()=>[t(s,{label:"时间范围"},{default:e(()=>[t(r,{modelValue:l.dateRange,"onUpdate:modelValue":a[0]||(a[0]=i=>l.dateRange=i),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),t(s,{label:"实验室"},{default:e(()=>[t(u,{modelValue:l.lab_id,"onUpdate:modelValue":a[1]||(a[1]=i=>l.lab_id=i),placeholder:"请选择实验室",clearable:"",filterable:""},{default:e(()=>[(D(!0),I(K,null,W(F.value,i=>(D(),X(_,{key:i.lab_id,label:i.lab_name,value:i.lab_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(s,{label:"预约状态"},{default:e(()=>[t(u,{modelValue:l.status,"onUpdate:modelValue":a[2]||(a[2]=i=>l.status=i),placeholder:"请选择状态",clearable:""},{default:e(()=>[t(_,{label:"待审核",value:"Pending"}),t(_,{label:"已批准",value:"Approved"}),t(_,{label:"已拒绝",value:"Rejected"}),t(_,{label:"已完成",value:"Completed"})]),_:1},8,["modelValue"])]),_:1}),t(s,null,{default:e(()=>[t(f,{type:"primary",onClick:O},{default:e(()=>[...a[3]||(a[3]=[x("查询",-1)])]),_:1}),t(f,{onClick:U},{default:e(()=>[...a[4]||(a[4]=[x("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(v,{gutter:20,class:"stats-cards"},{default:e(()=>[t(p,{span:6},{default:e(()=>[t(c,{class:"stat-card"},{default:e(()=>[o("div",ft,[o("div",bt,[t(b,null,{default:e(()=>[t(w(dt))]),_:1})]),o("div",vt,[o("div",yt,h(d.total),1),a[5]||(a[5]=o("div",{class:"stat-label"},"总预约数",-1))])])]),_:1})]),_:1}),t(p,{span:6},{default:e(()=>[t(c,{class:"stat-card"},{default:e(()=>[o("div",gt,[o("div",ht,[t(b,null,{default:e(()=>[t(w(it))]),_:1})]),o("div",Rt,[o("div",xt,h(d.approved),1),a[6]||(a[6]=o("div",{class:"stat-label"},"已批准",-1))])])]),_:1})]),_:1}),t(p,{span:6},{default:e(()=>[t(c,{class:"stat-card"},{default:e(()=>[o("div",wt,[o("div",Ct,[t(b,null,{default:e(()=>[t(w(ct))]),_:1})]),o("div",kt,[o("div",Dt,h(d.pending),1),a[7]||(a[7]=o("div",{class:"stat-label"},"待审核",-1))])])]),_:1})]),_:1}),t(p,{span:6},{default:e(()=>[t(c,{class:"stat-card"},{default:e(()=>[o("div",Et,[o("div",Yt,[t(b,null,{default:e(()=>[t(w(pt))]),_:1})]),o("div",At,[o("div",St,h(d.approvalRate)+"%",1),a[8]||(a[8]=o("div",{class:"stat-label"},"批准率",-1))])])]),_:1})]),_:1})]),_:1}),t(v,{gutter:20,class:"charts-row"},{default:e(()=>[t(p,{span:12},{default:e(()=>[t(c,null,{header:e(()=>[...a[9]||(a[9]=[o("span",null,"预约状态分布",-1)])]),default:e(()=>[o("div",{ref_key:"statusChart",ref:E,style:{height:"300px"}},null,512)]),_:1})]),_:1}),t(p,{span:12},{default:e(()=>[t(c,null,{header:e(()=>[...a[10]||(a[10]=[o("span",null,"每日预约趋势",-1)])]),default:e(()=>[o("div",{ref_key:"dailyTrendChart",ref:Y,style:{height:"300px"}},null,512)]),_:1})]),_:1})]),_:1}),t(v,{gutter:20,class:"charts-row"},{default:e(()=>[t(p,{span:12},{default:e(()=>[t(c,null,{header:e(()=>[...a[11]||(a[11]=[o("span",null,"实验室预约排行",-1)])]),default:e(()=>[o("div",{ref_key:"labRankingChart",ref:A,style:{height:"300px"}},null,512)]),_:1})]),_:1}),t(p,{span:12},{default:e(()=>[t(c,null,{header:e(()=>[...a[12]||(a[12]=[o("span",null,"时段预约分布",-1)])]),default:e(()=>[o("div",{ref_key:"timeSlotChart",ref:S,style:{height:"300px"}},null,512)]),_:1})]),_:1})]),_:1}),t(c,{class:"table-card"},{header:e(()=>[...a[13]||(a[13]=[o("span",null,"预约详细统计",-1)])]),default:e(()=>[t(R,{data:j.value,stripe:"",style:{width:"100%"}},{default:e(()=>[t(m,{prop:"lab_name",label:"实验室","min-width":"120"}),t(m,{prop:"total_reservations",label:"总预约数",width:"100"}),t(m,{prop:"approved_count",label:"已批准",width:"80"}),t(m,{prop:"pending_count",label:"待审核",width:"80"}),t(m,{prop:"rejected_count",label:"已拒绝",width:"80"}),t(m,{prop:"completed_count",label:"已完成",width:"80"}),t(m,{prop:"approval_rate",label:"批准率",width:"80"},{default:e(({row:i})=>[x(h(i.approval_rate)+"% ",1)]),_:1}),t(m,{prop:"utilization_rate",label:"使用率",width:"80"},{default:e(({row:i})=>[x(h(i.utilization_rate)+"% ",1)]),_:1})]),_:1},8,["data"])]),_:1})])}}},Kt=Q(Ft,[["__scopeId","data-v-4e3cf2b7"]]);export{Kt as default};
