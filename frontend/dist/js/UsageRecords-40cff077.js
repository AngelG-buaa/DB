import{_ as be}from"./_plugin-vue_export-helper-383fd9f4.js";/* empty css                   *//* empty css                             *//* empty css                  *//* empty css                   *//* empty css                 *//* empty css                        *//* empty css                      *//* empty css               *//* empty css                  *//* empty css                  *//* empty css                        *//* empty css                    */import"./el-tooltip-4ed993c7.js";/* empty css                             *//* empty css                  *//* empty css               *//* empty css                */import{r as g,b as P,v as ge,o as ve,c as y,d as E,e as p,z as k,w as t,f as e,k as I,E as ye,a5 as Ie,a6 as Ve,x as we,N as D,j as n,t as o,F as j,y as B,ai as De,A as K,Q as he,a7 as Ce,n as ke,p as xe,m as Ee,l as Re,ap as Ue,h as qe,ak as ze,al as Ye,am as Me,aj as Ne,an as Se,ao as Fe,aq as Oe,ae as Pe,aJ as je,aa as Be,aH as Te,aI as Ae,ar as Le,as as Qe,at as $e}from"./index-0407e335.js";import{e as He,a as Je,f as Ge,h as Ke}from"./consumable-97bf65e8.js";import{getLabsApi as We}from"./lab-ae8b6f89.js";const Xe={class:"usage-records"},Ze={class:"page-header"},ea={class:"stats-cards"},aa={class:"stats-content"},ta={class:"stats-number"},la={class:"stats-content"},sa={class:"stats-number"},oa={class:"stats-content"},na={class:"stats-number"},ua={class:"stats-content"},da={class:"stats-number"},ra={class:"pagination-wrapper"},ia={key:0,class:"form-tip"},pa={__name:"UsageRecords",setup(ma){const z=g(!1),Y=g(!1),T=g([]),R=g([]),A=g([]),V=g({totalRecords:0,monthlyRecords:0,totalQuantity:0,totalValue:0}),u=P({consumableId:"",labId:"",userId:"",usageDateRange:[]}),c=P({page:1,size:20,total:0}),x=g(!1),M=g(!1),U=g(!1),r=g(null),h=g(null),d=P({id:null,consumableId:"",quantity:1,userId:"",usageDate:"",purpose:"",remarks:""}),N=g(),W={consumableId:[{required:!0,message:"请选择耗材",trigger:"change"}],quantity:[{required:!0,message:"请输入使用数量",trigger:"blur"}],userId:[{required:!0,message:"请输入使用人员ID",trigger:"blur"}],usageDate:[{required:!0,message:"请选择使用日期",trigger:"change"}],purpose:[{required:!0,message:"请输入使用目的",trigger:"blur"}]},X=ge(()=>U.value?"编辑使用记录":"添加使用记录"),C=async()=>{var s,a,i;z.value=!0;try{const m={page:c.page,page_size:c.size,consumable_id:u.consumableId||void 0,user_id:u.userId||void 0,date_from:(s=u.usageDateRange)==null?void 0:s[0],date_to:(a=u.usageDateRange)==null?void 0:a[1]},_=await He(m);T.value=_.data.list||_.data.items||[],c.total=_.data.total||((i=_.data.pagination)==null?void 0:i.total)||0}catch{I.error("加载数据失败")}finally{z.value=!1}},Z=async()=>{try{const s=await Je({page_size:1e3});R.value=s.data.list||[]}catch{I.error("加载耗材选项失败")}},ee=async()=>{try{const s=await We({page:1,page_size:1e3});A.value=s.code===200?s.data.list||s.data:[]}catch{I.error("加载实验室选项失败")}},L=async()=>{var s,a,i;try{const m=await Ge(),_=((s=m.data)==null?void 0:s.byMonth)||[];V.value.totalRecords=(((a=m.data)==null?void 0:a.topConsumables)||[]).reduce((w,S)=>w+(Number(S.count)||0),0),V.value.monthlyRecords=((i=_.find(w=>w.month))==null?void 0:i.count)||0,V.value.totalQuantity=0,V.value.totalValue=0}catch{I.error("加载统计数据失败")}},ae=()=>{c.page=1,C()},te=()=>{Object.assign(u,{consumableId:"",labId:"",userId:"",usageDateRange:[]}),c.page=1,C()},le=async()=>{var s,a;try{const i={consumable_id:u.consumableId,laboratory_id:u.labId,user_id:u.userId,date_from:(s=u.usageDateRange)==null?void 0:s[0],date_to:(a=u.usageDateRange)==null?void 0:a[1]};await Ke(i),I.success("导出成功")}catch{I.error("导出失败")}},se=s=>{c.size=s,c.page=1,C()},oe=s=>{c.page=s,C()},ne=()=>{U.value=!1,Q(),d.usageDate=new Date().toISOString().split("T")[0],x.value=!0},ue=s=>{r.value=s,M.value=!0},de=s=>{h.value=R.value.find(a=>a.id===s)},re=async()=>{try{if(await N.value.validate(),Y.value=!0,U.value){I.error("暂不支持编辑使用记录");return}else await useConsumable(d.consumableId,{quantity:d.quantity,userId:d.userId,purpose:d.purpose}),I.success("创建成功");x.value=!1,C(),L()}catch(s){s!==!1&&I.error(U.value?"更新失败":"创建失败")}finally{Y.value=!1}},Q=()=>{Object.assign(d,{id:null,consumableId:"",quantity:1,userId:"",usageDate:"",purpose:"",remarks:""}),h.value=null},ie=()=>{var s;(s=N.value)==null||s.resetFields(),Q()};return ve(()=>{C(),Z(),ee(),L()}),(s,a)=>{const i=he,m=ye,_=Ie,w=Ce,S=Ve,F=ke,O=xe,v=Ee,q=Re,$=Ue,H=qe,f=ze,pe=Ye,me=Me,ce=Ne,J=we,b=Se,_e=Fe,fe=Oe;return y(),E("div",Xe,[p("div",Ze,[a[16]||(a[16]=p("h2",null,"耗材使用记录",-1)),(y(),k(m,{key:0,type:"primary",onClick:ne},{default:t(()=>[e(i,null,{default:t(()=>[e(D(Pe))]),_:1}),a[15]||(a[15]=n(" 添加使用记录 ",-1))]),_:1}))]),p("div",ea,[e(S,{gutter:20},{default:t(()=>[e(w,{span:6},{default:t(()=>[e(_,{class:"stats-card"},{default:t(()=>[p("div",aa,[p("div",ta,o(V.value.totalRecords),1),a[17]||(a[17]=p("div",{class:"stats-label"},"总使用记录",-1))]),e(i,{class:"stats-icon"},{default:t(()=>[e(D(je))]),_:1})]),_:1})]),_:1}),e(w,{span:6},{default:t(()=>[e(_,{class:"stats-card"},{default:t(()=>[p("div",la,[p("div",sa,o(V.value.monthlyRecords),1),a[18]||(a[18]=p("div",{class:"stats-label"},"本月使用",-1))]),e(i,{class:"stats-icon"},{default:t(()=>[e(D(Be))]),_:1})]),_:1})]),_:1}),e(w,{span:6},{default:t(()=>[e(_,{class:"stats-card"},{default:t(()=>[p("div",oa,[p("div",na,o(V.value.totalQuantity),1),a[19]||(a[19]=p("div",{class:"stats-label"},"总使用量",-1))]),e(i,{class:"stats-icon"},{default:t(()=>[e(D(Te))]),_:1})]),_:1})]),_:1}),e(w,{span:6},{default:t(()=>[e(_,{class:"stats-card"},{default:t(()=>[p("div",ua,[p("div",da,"¥"+o(V.value.totalValue),1),a[20]||(a[20]=p("div",{class:"stats-label"},"总价值",-1))]),e(i,{class:"stats-icon"},{default:t(()=>[e(D(Ae))]),_:1})]),_:1})]),_:1})]),_:1})]),e(_,{class:"search-card"},{default:t(()=>[e(H,{model:u,inline:""},{default:t(()=>[e(v,{label:"耗材"},{default:t(()=>[e(O,{modelValue:u.consumableId,"onUpdate:modelValue":a[0]||(a[0]=l=>u.consumableId=l),placeholder:"请选择耗材",clearable:"",filterable:"",style:{width:"200px"}},{default:t(()=>[(y(!0),E(j,null,B(R.value,l=>(y(),k(F,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(v,{label:"实验室"},{default:t(()=>[e(O,{modelValue:u.labId,"onUpdate:modelValue":a[1]||(a[1]=l=>u.labId=l),placeholder:"请选择实验室",clearable:"",style:{width:"150px"}},{default:t(()=>[(y(!0),E(j,null,B(A.value,l=>(y(),k(F,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(v,{label:"使用人员"},{default:t(()=>[e(q,{modelValue:u.userId,"onUpdate:modelValue":a[2]||(a[2]=l=>u.userId=l),placeholder:"请输入使用人员ID",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(v,{label:"使用日期"},{default:t(()=>[e($,{modelValue:u.usageDateRange,"onUpdate:modelValue":a[3]||(a[3]=l=>u.usageDateRange=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),e(v,null,{default:t(()=>[e(m,{type:"primary",onClick:ae},{default:t(()=>[e(i,null,{default:t(()=>[e(D(Le))]),_:1}),a[21]||(a[21]=n(" 搜索 ",-1))]),_:1}),e(m,{onClick:te},{default:t(()=>[e(i,null,{default:t(()=>[e(D(Qe))]),_:1}),a[22]||(a[22]=n(" 重置 ",-1))]),_:1}),e(m,{type:"success",onClick:le},{default:t(()=>[e(i,null,{default:t(()=>[e(D($e))]),_:1}),a[23]||(a[23]=n(" 导出 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),e(_,{class:"table-card"},{default:t(()=>[De((y(),k(pe,{data:T.value,stripe:"",style:{width:"100%"}},{default:t(()=>[e(f,{prop:"id",label:"记录ID",width:"100"}),e(f,{prop:"consumableName",label:"耗材名称","min-width":"120"}),e(f,{prop:"consumableModel",label:"型号/规格","min-width":"100"}),e(f,{prop:"labName",label:"实验室","min-width":"120"}),e(f,{prop:"quantity",label:"使用数量",width:"100"},{default:t(({row:l})=>[n(o(l.quantity)+" "+o(l.unit),1)]),_:1}),e(f,{prop:"unitPrice",label:"单价",width:"80"},{default:t(({row:l})=>[n(" ¥"+o(l.unitPrice),1)]),_:1}),e(f,{prop:"totalValue",label:"总价值",width:"100"},{default:t(({row:l})=>[n(" ¥"+o((l.quantity*l.unitPrice).toFixed(2)),1)]),_:1}),e(f,{prop:"userId",label:"使用人员",width:"100"}),e(f,{prop:"userName",label:"姓名",width:"100"}),e(f,{prop:"purpose",label:"使用目的","min-width":"150","show-overflow-tooltip":""}),e(f,{prop:"usageDate",label:"使用日期",width:"120"}),e(f,{prop:"createdAt",label:"记录时间",width:"160"}),e(f,{label:"操作",width:"150",fixed:"right"},{default:t(({row:l})=>[e(m,{type:"primary",size:"small",onClick:G=>ue(l)},{default:t(()=>[...a[24]||(a[24]=[n(" 详情 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[fe,z.value]]),p("div",ra,[e(me,{"current-page":c.page,"onUpdate:currentPage":a[4]||(a[4]=l=>c.page=l),"page-size":c.size,"onUpdate:pageSize":a[5]||(a[5]=l=>c.size=l),"page-sizes":[10,20,50,100],total:c.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:se,onCurrentChange:oe},null,8,["current-page","page-size","total"])])]),_:1}),e(J,{title:X.value,modelValue:x.value,"onUpdate:modelValue":a[13]||(a[13]=l=>x.value=l),width:"600px",onClose:ie},{footer:t(()=>[e(m,{onClick:a[12]||(a[12]=l=>x.value=!1)},{default:t(()=>[...a[25]||(a[25]=[n("取消",-1)])]),_:1}),e(m,{type:"primary",onClick:re,loading:Y.value},{default:t(()=>[...a[26]||(a[26]=[n(" 确定 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[e(H,{model:d,rules:W,ref_key:"formRef",ref:N,"label-width":"100px"},{default:t(()=>[e(v,{label:"耗材",prop:"consumableId"},{default:t(()=>[e(O,{modelValue:d.consumableId,"onUpdate:modelValue":a[6]||(a[6]=l=>d.consumableId=l),placeholder:"请选择耗材",filterable:"",style:{width:"100%"},onChange:de},{default:t(()=>[(y(!0),E(j,null,B(R.value,l=>(y(),k(F,{key:l.id,label:`${l.name} (${l.model})`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(v,{label:"使用数量",prop:"quantity"},{default:t(()=>{var l;return[e(ce,{modelValue:d.quantity,"onUpdate:modelValue":a[7]||(a[7]=G=>d.quantity=G),min:.01,max:(l=h.value)==null?void 0:l.currentStock,precision:2,style:{width:"100%"}},null,8,["modelValue","max"]),h.value?(y(),E("div",ia," 当前库存："+o(h.value.currentStock)+" "+o(h.value.unit),1)):K("",!0)]}),_:1}),e(v,{label:"使用人员",prop:"userId"},{default:t(()=>[e(q,{modelValue:d.userId,"onUpdate:modelValue":a[8]||(a[8]=l=>d.userId=l),placeholder:"请输入使用人员ID"},null,8,["modelValue"])]),_:1}),e(v,{label:"使用日期",prop:"usageDate"},{default:t(()=>[e($,{modelValue:d.usageDate,"onUpdate:modelValue":a[9]||(a[9]=l=>d.usageDate=l),type:"date",placeholder:"请选择使用日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),e(v,{label:"使用目的",prop:"purpose"},{default:t(()=>[e(q,{modelValue:d.purpose,"onUpdate:modelValue":a[10]||(a[10]=l=>d.purpose=l),type:"textarea",rows:3,placeholder:"请输入使用目的"},null,8,["modelValue"])]),_:1}),e(v,{label:"备注"},{default:t(()=>[e(q,{modelValue:d.remarks,"onUpdate:modelValue":a[11]||(a[11]=l=>d.remarks=l),type:"textarea",rows:2,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","modelValue"]),e(J,{title:"使用记录详情",modelValue:M.value,"onUpdate:modelValue":a[14]||(a[14]=l=>M.value=l),width:"600px"},{default:t(()=>[r.value?(y(),k(_e,{key:0,column:2,border:""},{default:t(()=>[e(b,{label:"记录ID"},{default:t(()=>[n(o(r.value.id),1)]),_:1}),e(b,{label:"耗材名称"},{default:t(()=>[n(o(r.value.consumableName),1)]),_:1}),e(b,{label:"型号/规格"},{default:t(()=>[n(o(r.value.consumableModel),1)]),_:1}),e(b,{label:"所属实验室"},{default:t(()=>[n(o(r.value.labName),1)]),_:1}),e(b,{label:"使用数量"},{default:t(()=>[n(o(r.value.quantity)+" "+o(r.value.unit),1)]),_:1}),e(b,{label:"单价"},{default:t(()=>[n(" ¥"+o(r.value.unitPrice),1)]),_:1}),e(b,{label:"总价值"},{default:t(()=>[n(" ¥"+o((r.value.quantity*r.value.unitPrice).toFixed(2)),1)]),_:1}),e(b,{label:"使用人员"},{default:t(()=>[n(o(r.value.userId)+" - "+o(r.value.userName),1)]),_:1}),e(b,{label:"使用日期"},{default:t(()=>[n(o(r.value.usageDate),1)]),_:1}),e(b,{label:"记录时间"},{default:t(()=>[n(o(r.value.createdAt),1)]),_:1}),e(b,{label:"使用目的",span:2},{default:t(()=>[n(o(r.value.purpose),1)]),_:1}),e(b,{label:"备注",span:2},{default:t(()=>[n(o(r.value.remarks||"无"),1)]),_:1})]),_:1})):K("",!0)]),_:1},8,["modelValue"])])}}},Ma=be(pa,[["__scopeId","data-v-1d571b67"]]);export{Ma as default};
