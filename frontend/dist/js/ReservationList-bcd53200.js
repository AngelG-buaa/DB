import{_ as Ye}from"./_plugin-vue_export-helper-383fd9f4.js";/* empty css                   *//* empty css                 *//* empty css                  *//* empty css                   *//* empty css                         *//* empty css                             *//* empty css                *//* empty css                      *//* empty css               *//* empty css                  *//* empty css                  *//* empty css                        *//* empty css                    */import"./el-tooltip-4ed993c7.js";/* empty css                  *//* empty css                        *//* empty css                         *//* empty css                             */import{u as Ae,a as je,r as g,b as B,o as Ue,ah as Be,c as d,d as D,f as a,w as l,a5 as $e,x as Fe,e as p,N as z,j as s,F as W,y as X,z as y,ai as Le,t as r,A as b,k as $,P as Z,J as V,Q as Se,E as He,n as Ne,p as Pe,m as Oe,ap as qe,h as Je,ak as Qe,a8 as Ge,_ as Ke,$ as We,a0 as Xe,al as Ze,am as et,an as tt,ao as at,av as lt,aw as ot,l as st,aq as nt,ae as rt,ar as it,as as dt,ax as ut}from"./index-0407e335.js";import{getReservationsApi as pt,getReservationByIdApi as ct,approveReservationApi as mt,rejectReservationApi as _t,cancelReservationApi as vt,deleteReservationApi as ft}from"./reservation-e2a96893.js";import{getLabsApi as gt}from"./lab-ae8b6f89.js";const yt={class:"reservation-list-container"},bt={class:"card-header"},kt={class:"search-section"},ht={class:"text-secondary"},xt={class:"text-secondary"},Dt={class:"pagination-container"},Vt={key:0,class:"reservation-detail"},Et={key:0,class:"approval-records"},Ct={class:"approval-content"},It={class:"approval-action"},Rt={class:"approval-user"},Mt={key:0,class:"approval-remarks"},Tt={class:"dialog-footer"},wt={class:"dialog-footer"},zt={__name:"ReservationList",setup(Yt){const ee=Ae(),E=je(),Y=g(!1),F=g([]),L=g([]),M=g(!1),C=g(!1),A=g(!1),i=g(null),k=g(""),j=g(),u=B({labId:"",status:"",dateRange:[]}),c=B({page:1,size:20,total:0}),I=B({remarks:""}),te={remarks:[{required:!0,message:"请输入拒绝原因",trigger:"blur",validator:(t,e,n)=>{k.value==="reject"&&!e?n(new Error("请输入拒绝原因")):n()}}]},v=async()=>{var t,e;try{Y.value=!0;const n={page:c.page,page_size:c.size,laboratory_id:u.labId||void 0,status:u.status||void 0,date_from:((t=u.dateRange)==null?void 0:t[0])||void 0,date_to:((e=u.dateRange)==null?void 0:e[1])||void 0},m=await pt(n);m.code===200&&(F.value=m.data.list,c.total=m.data.total)}catch(n){console.error("加载预约列表失败:",n)}finally{Y.value=!1}},ae=async()=>{try{const t=await gt({page:1,page_size:100});t.code===200&&(L.value=t.data.list)}catch(t){console.error("加载实验室选项失败:",t)}},le=()=>{c.page=1,v()},oe=()=>{u.labId="",u.status="",u.dateRange=[],c.page=1,v()},se=t=>{c.size=t,c.page=1,v()},ne=t=>{c.page=t,v()},re=async t=>{try{const e=await ct(t.id);e.code===200&&(i.value=e.data,M.value=!0)}catch(e){console.error("获取预约详情失败:",e)}},ie=()=>{ee.push("/reservation/create")},de=t=>{const{action:e,row:n}=t;switch(e){case"approve":S(n,"approve");break;case"reject":S(n,"reject");break;case"cancel":pe(n);break;case"delete":H(n);break}},S=(t,e)=>{i.value=t,k.value=e,I.remarks="",C.value=!0},ue=async()=>{if(j.value)try{await j.value.validate(),A.value=!0,(await(k.value==="approve"?mt:_t)(i.value.id,{remarks:I.remarks})).code===200&&($.success(`预约${k.value==="approve"?"通过":"拒绝"}成功`),C.value=!1,v())}catch(t){console.error("审核预约失败:",t)}finally{A.value=!1}},pe=async t=>{try{await Z.confirm("确定要取消这个预约吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await vt(t.id,{remarks:"用户取消"})).code===200&&($.success("预约取消成功"),v())}catch(e){e!=="cancel"&&console.error("取消预约失败:",e)}},H=async t=>{try{await Z.confirm("确定要删除这个预约吗？删除后无法恢复。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),(await ft(t.id)).code===200&&($.success("预约删除成功"),v())}catch(e){e!=="cancel"&&console.error("删除预约失败:",e)}},ce=t=>{const e=E.userInfo;return e.user_type==="admin"||e.user_type==="teacher"||t.user_id===e.id},me=t=>{const e=E.userInfo;return t.status==="pending"&&(e.user_type==="admin"||e.user_type==="teacher")},_e=t=>{const e=E.userInfo;return t.status==="pending"&&(e.user_type==="admin"||e.user_type==="teacher")},ve=t=>{const e=E.userInfo;return(t.status==="pending"||t.status==="approved")&&(e.user_type==="admin"||t.user_id===e.id)},N=t=>{const e=E.userInfo;return e.user_type==="admin"?!0:e.user_type==="teacher"?t.user_id===e.id:!1},T=t=>V(t).isValid()?V(t).format("YYYY-MM-DD HH:mm"):"",P=t=>{if(!t)return"";const e=String(t);return e.length===5?`${e}:00`:e},U=(t,e)=>{if(!t||!e)return"";const n=`${t} ${P(e)}`;return V(n).isValid()?V(n).format("YYYY-MM-DD HH:mm"):""},fe=(t,e)=>{if(!t||!e)return"";const n=`${t} ${P(e)}`;return V(n).isValid()?V(n).format("HH:mm"):""},O=t=>({pending:"warning",approved:"success",rejected:"danger",completed:"info",cancelled:"info"})[t]||"info",q=t=>({pending:"待审核",approved:"已通过",rejected:"已拒绝",completed:"已完成",cancelled:"已取消"})[t]||"未知",ge=t=>({admin:"管理员",teacher:"教师",student:"学生"})[t]||"未知",ye=t=>t.user_type||t.role||t.userRole||t.user&&(t.user.role||t.user.user_type)||"",be=t=>t.user_name||t.real_name||t.username||t.user&&(t.user.real_name||t.user.username)||"未知",ke=t=>({approve:"success",reject:"danger",cancel:"warning"})[t]||"primary",he=t=>({approve:"通过",reject:"拒绝",cancel:"取消"})[t]||"未知";return Ue(()=>{ae(),v()}),Be(()=>{v()}),(t,e)=>{const n=Se,m=He,x=Ne,J=Pe,R=Oe,xe=qe,Q=Je,h=Qe,G=Ge,w=Ke,De=We,Ve=Xe,Ee=Ze,Ce=et,Ie=$e,_=tt,Re=at,Me=lt,Te=ot,K=Fe,we=st,ze=nt;return d(),D("div",yt,[a(Ie,null,{header:l(()=>[p("div",bt,[e[11]||(e[11]=p("span",null,"预约管理",-1)),a(m,{type:"primary",onClick:ie},{default:l(()=>[a(n,null,{default:l(()=>[a(z(rt))]),_:1}),e[10]||(e[10]=s(" 新建预约 ",-1))]),_:1})])]),default:l(()=>[p("div",kt,[a(Q,{model:u,inline:!0,class:"search-form"},{default:l(()=>[a(R,{label:"实验室"},{default:l(()=>[a(J,{modelValue:u.labId,"onUpdate:modelValue":e[0]||(e[0]=o=>u.labId=o),placeholder:"请选择实验室",clearable:"",style:{width:"200px"}},{default:l(()=>[(d(!0),D(W,null,X(L.value,o=>(d(),y(x,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(R,{label:"状态"},{default:l(()=>[a(J,{modelValue:u.status,"onUpdate:modelValue":e[1]||(e[1]=o=>u.status=o),placeholder:"请选择状态",clearable:"",style:{width:"150px"}},{default:l(()=>[a(x,{label:"待审核",value:"pending"}),a(x,{label:"已通过",value:"approved"}),a(x,{label:"已拒绝",value:"rejected"}),a(x,{label:"已完成",value:"completed"}),a(x,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),_:1}),a(R,{label:"预约时间"},{default:l(()=>[a(xe,{modelValue:u.dateRange,"onUpdate:modelValue":e[2]||(e[2]=o=>u.dateRange=o),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),a(R,null,{default:l(()=>[a(m,{type:"primary",onClick:le},{default:l(()=>[a(n,null,{default:l(()=>[a(z(it))]),_:1}),e[12]||(e[12]=s(" 搜索 ",-1))]),_:1}),a(m,{onClick:oe},{default:l(()=>[a(n,null,{default:l(()=>[a(z(dt))]),_:1}),e[13]||(e[13]=s(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),Le((d(),y(Ee,{data:F.value,stripe:"",class:"reservation-table"},{default:l(()=>[a(h,{prop:"id",label:"预约ID",width:"80"}),a(h,{prop:"lab_name",label:"实验室",width:"150"}),a(h,{label:"预约时间",width:"220"},{default:l(({row:o})=>[p("div",null,r(U(o.reservation_date,o.start_time)),1),p("div",ht,"至 "+r(fe(o.reservation_date,o.end_time)),1)]),_:1}),a(h,{prop:"purpose",label:"使用目的","min-width":"150","show-overflow-tooltip":""}),a(h,{label:"预约人",width:"140"},{default:l(({row:o})=>[p("div",null,r(be(o)),1),p("div",xt,r(ge(ye(o))),1)]),_:1}),a(h,{label:"状态",width:"100"},{default:l(({row:o})=>[a(G,{type:O(o.status)},{default:l(()=>[s(r(q(o.status)),1)]),_:2},1032,["type"])]),_:1}),a(h,{label:"创建时间",width:"160"},{default:l(({row:o})=>[s(r(T(o.created_at)),1)]),_:1}),a(h,{label:"操作",width:"200",fixed:"right"},{default:l(({row:o})=>[a(m,{type:"primary",size:"small",onClick:f=>re(o)},{default:l(()=>[...e[14]||(e[14]=[s("查看",-1)])]),_:1},8,["onClick"]),N(o)?(d(),y(m,{key:0,type:"danger",size:"small",onClick:f=>H(o)},{default:l(()=>[...e[15]||(e[15]=[s("删除",-1)])]),_:1},8,["onClick"])):b("",!0),ce(o)?(d(),y(Ve,{key:1,onCommand:de},{dropdown:l(()=>[a(De,null,{default:l(()=>[me(o)?(d(),y(w,{key:0,command:{action:"approve",row:o}},{default:l(()=>[...e[17]||(e[17]=[s(" 通过 ",-1)])]),_:1},8,["command"])):b("",!0),_e(o)?(d(),y(w,{key:1,command:{action:"reject",row:o}},{default:l(()=>[...e[18]||(e[18]=[s(" 拒绝 ",-1)])]),_:1},8,["command"])):b("",!0),ve(o)?(d(),y(w,{key:2,command:{action:"cancel",row:o}},{default:l(()=>[...e[19]||(e[19]=[s(" 取消 ",-1)])]),_:1},8,["command"])):b("",!0),N(o)?(d(),y(w,{key:3,command:{action:"delete",row:o},divided:""},{default:l(()=>[...e[20]||(e[20]=[s(" 删除 ",-1)])]),_:1},8,["command"])):b("",!0)]),_:2},1024)]),default:l(()=>[a(m,{type:"info",size:"small"},{default:l(()=>[e[16]||(e[16]=s(" 更多",-1)),a(n,{class:"el-icon--right"},{default:l(()=>[a(z(ut))]),_:1})]),_:1})]),_:2},1024)):b("",!0)]),_:1})]),_:1},8,["data"])),[[ze,Y.value]]),p("div",Dt,[a(Ce,{"current-page":c.page,"onUpdate:currentPage":e[3]||(e[3]=o=>c.page=o),"page-size":c.size,"onUpdate:pageSize":e[4]||(e[4]=o=>c.size=o),total:c.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:se,onCurrentChange:ne},null,8,["current-page","page-size","total"])])]),_:1}),a(K,{modelValue:M.value,"onUpdate:modelValue":e[6]||(e[6]=o=>M.value=o),title:"预约详情",width:"600px"},{footer:l(()=>[p("span",Tt,[a(m,{onClick:e[5]||(e[5]=o=>M.value=!1)},{default:l(()=>[...e[22]||(e[22]=[s("关闭",-1)])]),_:1})])]),default:l(()=>{var o;return[i.value?(d(),D("div",Vt,[a(Re,{column:2,border:""},{default:l(()=>[a(_,{label:"预约ID"},{default:l(()=>[s(r(i.value.id),1)]),_:1}),a(_,{label:"状态"},{default:l(()=>[a(G,{type:O(i.value.status)},{default:l(()=>[s(r(q(i.value.status)),1)]),_:1},8,["type"])]),_:1}),a(_,{label:"实验室"},{default:l(()=>[s(r(i.value.lab_name),1)]),_:1}),a(_,{label:"预约人"},{default:l(()=>[s(r(i.value.user_name),1)]),_:1}),a(_,{label:"开始时间"},{default:l(()=>[s(r(U(i.value.reservation_date,i.value.start_time)),1)]),_:1}),a(_,{label:"结束时间"},{default:l(()=>[s(r(U(i.value.reservation_date,i.value.end_time)),1)]),_:1}),a(_,{label:"使用目的",span:2},{default:l(()=>[s(r(i.value.purpose),1)]),_:1}),a(_,{label:"备注",span:2},{default:l(()=>[s(r(i.value.remarks||"无"),1)]),_:1}),a(_,{label:"创建时间"},{default:l(()=>[s(r(T(i.value.created_at)),1)]),_:1}),a(_,{label:"更新时间"},{default:l(()=>[s(r(T(i.value.updated_at)),1)]),_:1})]),_:1}),(o=i.value.approval_records)!=null&&o.length?(d(),D("div",Et,[e[21]||(e[21]=p("h4",null,"审核记录",-1)),a(Te,null,{default:l(()=>[(d(!0),D(W,null,X(i.value.approval_records,f=>(d(),y(Me,{key:f.id,timestamp:T(f.created_at),type:ke(f.action)},{default:l(()=>[p("div",Ct,[p("div",It,r(he(f.action)),1),p("div",Rt,"操作人："+r(f.operator_name),1),f.remarks?(d(),D("div",Mt,"备注："+r(f.remarks),1)):b("",!0)])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):b("",!0)])):b("",!0)]}),_:1},8,["modelValue"]),a(K,{modelValue:C.value,"onUpdate:modelValue":e[9]||(e[9]=o=>C.value=o),title:k.value==="approve"?"通过预约":"拒绝预约",width:"500px"},{footer:l(()=>[p("span",wt,[a(m,{onClick:e[8]||(e[8]=o=>C.value=!1)},{default:l(()=>[...e[23]||(e[23]=[s("取消",-1)])]),_:1}),a(m,{type:k.value==="approve"?"success":"danger",loading:A.value,onClick:ue},{default:l(()=>[s(" 确认"+r(k.value==="approve"?"通过":"拒绝"),1)]),_:1},8,["type","loading"])])]),default:l(()=>[a(Q,{ref_key:"approvalFormRef",ref:j,model:I,rules:te,"label-width":"80px"},{default:l(()=>[a(R,{label:"备注",prop:"remarks"},{default:l(()=>[a(we,{modelValue:I.remarks,"onUpdate:modelValue":e[7]||(e[7]=o=>I.remarks=o),type:"textarea",rows:4,placeholder:k.value==="approve"?"请输入通过原因（可选）":"请输入拒绝原因"},null,8,["modelValue","placeholder"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},aa=Ye(zt,[["__scopeId","data-v-6c077817"]]);export{aa as default};
