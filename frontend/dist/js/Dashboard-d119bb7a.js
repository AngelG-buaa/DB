import{_ as it}from"./_plugin-vue_export-helper-383fd9f4.js";/* empty css                 *//* empty css               *//* empty css                  *//* empty css               *//* empty css                *//* empty css                  */import{u as lt,a as rt,r as D,b as N,v as T,o as dt,c as p,d as b,e as t,f as s,w as e,J as w,a4 as ct,a5 as ut,a6 as _t,t as c,N as f,j as g,F as O,y as I,A as x,O as pt,z as $,k as ft,Q as vt,Z as mt,a7 as gt,E as yt,a8 as ht,a3 as bt,a9 as wt,aa as St,ab as Rt,ac as kt,ad as B,ae as Ct,af as Dt,ag as xt}from"./index-0407e335.js";import{i as H}from"./index-18acf776.js";import{getReservationStatsApi as j,getMyReservationsApi as F}from"./reservation-e2a96893.js";import{g as Mt}from"./maintenance-0ef2aad3.js";import{g as Et}from"./consumable-97bf65e8.js";import{getLabsApi as zt}from"./lab-ae8b6f89.js";const Tt={class:"dashboard-container"},At={class:"welcome-section"},Lt={class:"welcome-content"},Nt={class:"welcome-text"},Ot={class:"welcome-avatar"},It={class:"stats-section"},$t={class:"stat-content"},Bt={class:"stat-icon total"},Ht={class:"stat-info"},jt={class:"stat-value"},Ft={class:"stat-content"},Vt={class:"stat-icon active"},Yt={class:"stat-info"},qt={class:"stat-value"},Pt={class:"stat-content"},Jt={class:"stat-icon pending"},Qt={class:"stat-info"},Ut={class:"stat-value"},Zt={class:"stat-content"},Gt={class:"stat-icon labs"},Kt={class:"stat-info"},Wt={class:"stat-value"},Xt={class:"card-header"},ts={class:"reservation-list"},ss={class:"reservation-info"},as={class:"lab-name"},es={class:"reservation-time"},os={class:"reservation-status"},ns={key:0,class:"empty-state"},is={class:"card-header"},ls={class:"notification-list"},rs=["onClick"],ds={class:"notification-content"},cs={class:"notification-title"},us={class:"notification-time"},_s={key:0,class:"empty-state"},ps={class:"quick-actions"},fs={class:"action-buttons"},vs={__name:"Dashboard",setup(ms){const S=lt(),V=rt(),M=D(),E=D(),v=N({totalReservations:0,activeReservations:0,pendingReservations:0,availableLabs:0}),k=N({byDate:[],byLaboratory:[]}),z=D([]),C=D([]),R=T(()=>V.userInfo),Y=T(()=>w().format("YYYY年MM月DD日")),q=T(()=>{const o=new Date().getHours();return o<6?"夜深了，注意休息":o<12?"早上好，新的一天开始了":o<18?"下午好，工作顺利":"晚上好，辛苦了"}),P=async()=>{try{const o=await j();if(o.code===200){const r=o.data||{},n=r.status_distribution||{};v.totalReservations=r.total_reservations||0,v.activeReservations=(n.confirmed||0)+(n.approved||0),v.pendingReservations=n.pending||0,k.byDate=r.by_date||r.daily_trend||[],k.byLaboratory=r.by_laboratory||r.laboratory_distribution||[]}const a=await zt({page:1,page_size:1,status:"available"});a.code===200&&(v.availableLabs=a.data.total||(Array.isArray(a.data)?a.data.length:0));const l=await F({page:1,page_size:5});if(l.code===200){const r=l.data.list||[];z.value=r.map(n=>{var d;return{id:n.id,lab_name:((d=n.laboratory)==null?void 0:d.name)||"",start_time:n.start_time,end_time:n.end_time,status:n.status}})}}catch(o){console.error("加载仪表板数据失败:",o)}},J=async()=>{var o,a,l,r,n;try{const d=(o=R.value)==null?void 0:o.role,_=[];if(["admin","teacher"].includes(d)){const[u,y,m]=await Promise.all([j({}),Mt({}),Et()]);if(u.code===200){const h=(((a=u.data)==null?void 0:a.status_distribution)||{}).pending||0;h>0&&_.push({id:"pending-resv",title:`待审核预约 ${h} 条`,is_read:!1,created_at:new Date().toISOString()})}if(y.code===200){const i=((l=y.data)==null?void 0:l.inProgress)||0;i>0&&_.push({id:"maint-ip",title:`设备维修进行中 ${i} 条`,is_read:!1,created_at:new Date().toISOString()})}if(m.code===200){const i=((r=m.data)==null?void 0:r.lowStock)||0;i>0&&_.push({id:"cons-low",title:`耗材低库存 ${i} 项`,is_read:!1,created_at:new Date().toISOString()})}}else{const u=await F({page:1,page_size:200});if(u.code===200){const y=((n=u.data)==null?void 0:n.list)||[],m=w(),i=y.filter(h=>{const ot=h.reservation_date,nt=h.start_time||"00:00:00",L=w(`${ot} ${nt}`);return L.isAfter(m)&&L.diff(m,"hour")<=48&&["pending","confirmed"].includes(h.status)});i.length>0&&_.push({id:"my-upcoming",title:`未来48小时内有 ${i.length} 条预约`,is_read:!1,created_at:new Date().toISOString()})}}C.value=_}catch{C.value=[]}},Q=async()=>{if(await ct(),M.value){const o=H(M.value),a=(k.byDate||[]).slice(-7),l=a.map(d=>w(d.date).format("MM-DD")),r=a.map(d=>d.count),n={title:{text:"最近7天预约趋势",textStyle:{fontSize:14,color:"#606266"}},tooltip:{trigger:"axis"},xAxis:{type:"category",data:l},yAxis:{type:"value"},series:[{data:r,type:"line",smooth:!0,itemStyle:{color:"#409EFF"}}]};o.setOption(n)}if(E.value){const o=H(E.value),a=(k.byLaboratory||[]).map(r=>({value:r.count||r.reservation_count,name:r.laboratory_name})),l={title:{text:"实验室使用率",textStyle:{fontSize:14,color:"#606266"}},tooltip:{trigger:"item"},series:[{type:"pie",radius:"60%",data:a}]};o.setOption(l)}},A=o=>w(o).format("MM-DD HH:mm"),U=o=>w(o).format("HH:mm"),Z=o=>({pending:"warning",approved:"success",rejected:"danger",completed:"info",cancelled:"info"})[o]||"info",G=o=>({pending:"待审核",approved:"已通过",rejected:"已拒绝",completed:"已完成",cancelled:"已取消"})[o]||"未知",K=o=>{o.is_read||(o.is_read=!0)},W=()=>{S.push("/reservation/list")},X=()=>{ft.info("请点击右上角铃铛查看通知")},tt=()=>{S.push("/reservation/create")},st=()=>{S.push("/laboratory/list")},at=()=>{S.push("/equipment/list")},et=()=>{S.push("/course/list")};return dt(async()=>{await P(),await J(),await Q()}),(o,a)=>{const l=vt,r=mt,n=ut,d=gt,_=_t,u=yt,y=ht,m=bt;return p(),b("div",Tt,[t("div",At,[s(n,{class:"welcome-card"},{default:e(()=>[t("div",Lt,[t("div",Nt,[t("h2",null,"欢迎回来，"+c(R.value.real_name||R.value.username)+"！",1),t("p",null,"今天是 "+c(Y.value)+"，"+c(q.value),1)]),t("div",Ot,[s(r,{size:60,src:R.value.avatar},{default:e(()=>[s(l,null,{default:e(()=>[s(f(wt))]),_:1})]),_:1},8,["src"])])])]),_:1})]),t("div",It,[s(_,{gutter:20},{default:e(()=>[s(d,{span:6},{default:e(()=>[s(n,{class:"stat-card"},{default:e(()=>[t("div",$t,[t("div",Bt,[s(l,null,{default:e(()=>[s(f(St))]),_:1})]),t("div",Ht,[t("div",jt,c(v.totalReservations),1),a[0]||(a[0]=t("div",{class:"stat-label"},"总预约数",-1))])])]),_:1})]),_:1}),s(d,{span:6},{default:e(()=>[s(n,{class:"stat-card"},{default:e(()=>[t("div",Ft,[t("div",Vt,[s(l,null,{default:e(()=>[s(f(Rt))]),_:1})]),t("div",Yt,[t("div",qt,c(v.activeReservations),1),a[1]||(a[1]=t("div",{class:"stat-label"},"进行中",-1))])])]),_:1})]),_:1}),s(d,{span:6},{default:e(()=>[s(n,{class:"stat-card"},{default:e(()=>[t("div",Pt,[t("div",Jt,[s(l,null,{default:e(()=>[s(f(kt))]),_:1})]),t("div",Qt,[t("div",Ut,c(v.pendingReservations),1),a[2]||(a[2]=t("div",{class:"stat-label"},"待审核",-1))])])]),_:1})]),_:1}),s(d,{span:6},{default:e(()=>[s(n,{class:"stat-card"},{default:e(()=>[t("div",Zt,[t("div",Gt,[s(l,null,{default:e(()=>[s(f(B))]),_:1})]),t("div",Kt,[t("div",Wt,c(v.availableLabs),1),a[3]||(a[3]=t("div",{class:"stat-label"},"可用实验室",-1))])])]),_:1})]),_:1})]),_:1})]),s(_,{gutter:20,class:"main-content"},{default:e(()=>[s(d,{span:12},{default:e(()=>[s(n,{class:"content-card"},{header:e(()=>[t("div",Xt,[a[5]||(a[5]=t("span",null,"我的预约",-1)),s(u,{type:"text",onClick:W},{default:e(()=>[...a[4]||(a[4]=[g("查看全部",-1)])]),_:1})])]),default:e(()=>[t("div",ts,[(p(!0),b(O,null,I(z.value,i=>(p(),b("div",{key:i.id,class:"reservation-item"},[t("div",ss,[t("div",as,c(i.lab_name),1),t("div",es,c(A(i.start_time))+" - "+c(U(i.end_time)),1)]),t("div",os,[s(y,{type:Z(i.status)},{default:e(()=>[g(c(G(i.status)),1)]),_:2},1032,["type"])])]))),128)),z.value.length===0?(p(),b("div",ns,[s(m,{description:"暂无预约记录"})])):x("",!0)])]),_:1})]),_:1}),s(d,{span:12},{default:e(()=>[s(n,{class:"content-card"},{header:e(()=>[t("div",is,[a[7]||(a[7]=t("span",null,"通知公告",-1)),s(u,{type:"text",onClick:X},{default:e(()=>[...a[6]||(a[6]=[g("查看全部",-1)])]),_:1})])]),default:e(()=>[t("div",ls,[(p(!0),b(O,null,I(C.value,i=>(p(),b("div",{key:i.id,class:"notification-item",onClick:h=>K(i)},[t("div",ds,[t("div",cs,[t("span",{class:pt({unread:!i.is_read})},c(i.title),3),i.is_read?x("",!0):(p(),$(y,{key:0,type:"danger",size:"small"},{default:e(()=>[...a[8]||(a[8]=[g("新",-1)])]),_:1}))]),t("div",us,c(A(i.created_at)),1)])],8,rs))),128)),C.value.length===0?(p(),b("div",_s,[s(m,{description:"暂无通知"})])):x("",!0)])]),_:1})]),_:1})]),_:1}),s(_,{gutter:20,class:"chart-section"},{default:e(()=>[s(d,{span:12},{default:e(()=>[s(n,{class:"chart-card"},{header:e(()=>[...a[9]||(a[9]=[t("div",{class:"card-header"},[t("span",null,"预约趋势")],-1)])]),default:e(()=>[t("div",{ref_key:"reservationChartRef",ref:M,class:"chart-container"},null,512)]),_:1})]),_:1}),s(d,{span:12},{default:e(()=>[s(n,{class:"chart-card"},{header:e(()=>[...a[10]||(a[10]=[t("div",{class:"card-header"},[t("span",null,"实验室使用率")],-1)])]),default:e(()=>[t("div",{ref_key:"usageChartRef",ref:E,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1}),t("div",ps,[s(n,null,{header:e(()=>[...a[11]||(a[11]=[t("div",{class:"card-header"},[t("span",null,"快速操作")],-1)])]),default:e(()=>[t("div",fs,[s(u,{type:"primary",size:"large",onClick:tt},{default:e(()=>[s(l,null,{default:e(()=>[s(f(Ct))]),_:1}),a[12]||(a[12]=g(" 新建预约 ",-1))]),_:1}),s(u,{type:"success",size:"large",onClick:st},{default:e(()=>[s(l,null,{default:e(()=>[s(f(B))]),_:1}),a[13]||(a[13]=g(" 浏览实验室 ",-1))]),_:1}),s(u,{type:"warning",size:"large",onClick:at},{default:e(()=>[s(l,null,{default:e(()=>[s(f(Dt))]),_:1}),a[14]||(a[14]=g(" 设备管理 ",-1))]),_:1}),R.value.role==="teacher"?(p(),$(u,{key:0,type:"info",size:"large",onClick:et},{default:e(()=>[s(l,null,{default:e(()=>[s(f(xt))]),_:1}),a[15]||(a[15]=g(" 课程管理 ",-1))]),_:1})):x("",!0)])]),_:1})])])}}},zs=it(vs,[["__scopeId","data-v-435ac94b"]]);export{zs as default};
