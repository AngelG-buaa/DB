import{_ as me}from"./_plugin-vue_export-helper-383fd9f4.js";/* empty css                   *//* empty css                 *//* empty css                  *//* empty css                        *//* empty css                  *//* empty css                         *//* empty css                  *//* empty css                     */import"./el-tooltip-4ed993c7.js";import{G as pe,u as fe,a as he,r as A,v as O,o as ge,H as ve,I as g,c as s,d,f as n,w as e,J as P,K as ye,L as we,e as r,A as $,F as E,y as R,z as c,M as L,t as u,j as p,N as V,T as ke,O as be,P as xe,Q as Se,R as Ee,S as Be,U as Me,V as Ce,E as De,W as Ie,X as Ae,Y as $e,Z as Re,_ as Le,$ as Ve,a0 as Ne,a1 as ze,a2 as Te,a3 as Ue}from"./index-0407e335.js";import{_ as Fe}from"./logo-a60c622a.js";import{getReservationStatsApi as He,getMyReservationsApi as Oe}from"./reservation-e2a96893.js";import{g as Pe}from"./maintenance-0ef2aad3.js";import{g as je}from"./consumable-97bf65e8.js";const qe="/logo-mini.svg";const Ge={class:"main-layout"},Je={class:"logo"},Ke={key:0,src:Fe,alt:"Logo"},Qe={key:1,src:qe,alt:"Logo"},We={key:2,class:"title"},Xe={class:"header-left"},Ye={class:"header-right"},Ze={class:"user-info"},et={class:"username"},tt={class:"notification-list"},nt={class:"notification-header"},at={class:"title"},ot={class:"time"},st={class:"notification-content"},lt={class:"notification-actions"},it={key:0,class:"empty-notifications"},ct={__name:"MainLayout",setup(rt){const N=pe(),B=fe(),f=he(),v=A(!1),z=A(!1),y=A([]),S=A(0),K=O(()=>{const{path:l}=N;return l}),Q=O(()=>N.matched.filter(a=>a.meta&&a.meta.title).map(a=>({path:a.path,title:a.meta.title}))),W=O(()=>{const a=B.getRoutes().find(o=>o.path==="/");return!a||!a.children?[]:a.children.filter(o=>!o.meta||!o.meta.title||!o.meta.icon?!1:o.meta.roles&&o.meta.roles.length>0?f.hasRole(o.meta.roles):!0)}),X=()=>{v.value=!v.value},T=(l,a)=>("/"+[l,a].filter(Boolean).join("/")).replace(/\/+/,"/"),Y=l=>{switch(l){case"profile":B.push("/profile");break;case"settings":B.push("/settings");break;case"logout":Z();break}},Z=()=>{xe.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{f.logout().then(()=>{B.push("/login")})})},ee=()=>{z.value=!0,j()},j=async()=>{var l,a,o,w,M,C;try{const D=((l=f.userInfo)==null?void 0:l.role)||((a=f.userInfo)==null?void 0:a.user_type),k=[];if(["admin","teacher"].includes(D)){const[_,h,b]=await Promise.all([He({}),Pe({}),je()]);if(_.code===200){const m=(((o=_.data)==null?void 0:o.status_distribution)||{}).pending||0;m>0&&k.push({id:"pending-resv",title:`待审核预约 ${m} 条`,content:`待审核预约 ${m} 条`,is_read:!1,created_at:new Date().toISOString()})}if(h.code===200){const i=((w=h.data)==null?void 0:w.inProgress)||0;i>0&&k.push({id:"maint-ip",title:`设备维修进行中 ${i} 条`,content:`设备维修进行中 ${i} 条`,is_read:!1,created_at:new Date().toISOString()})}if(b.code===200){const i=((M=b.data)==null?void 0:M.lowStock)||0;i>0&&k.push({id:"cons-low",title:`耗材低库存 ${i} 项`,content:`耗材低库存 ${i} 项`,is_read:!1,created_at:new Date().toISOString()})}}else{const _=await Oe({page:1,page_size:200});if(_.code===200){const h=((C=_.data)==null?void 0:C.list)||[],b=P(),i=h.filter(m=>{const U=m.reservation_date,F=m.start_time||"00:00:00",I=P(`${U} ${F}`);return I.isAfter(b)&&I.diff(b,"hour")<=48&&["pending","confirmed"].includes(m.status)});i.length>0&&k.push({id:"my-upcoming",title:`未来48小时内有 ${i.length} 条预约`,content:`未来48小时内有 ${i.length} 条预约`,is_read:!1,created_at:new Date().toISOString()})}}y.value=k,S.value=y.value.filter(_=>!_.is_read).length}catch{y.value=[],S.value=0}},te=async l=>{const a=y.value.find(o=>o.id===l);a&&(a.is_read=!0,S.value=y.value.filter(o=>!o.is_read).length)},ne=l=>P(l).format("MM-DD HH:mm");return ge(()=>{j()}),ve(N,()=>{}),(l,a)=>{const o=Se,w=Ee,M=Be,C=Me,D=Ce,k=g("Expand"),_=g("Fold"),h=De,b=Ie,i=Ae,m=g("Bell"),U=$e,F=Re,I=g("ArrowDown"),ae=g("User"),H=Le,oe=g("Setting"),se=g("SwitchButton"),le=Ve,ie=Ne,ce=ze,re=g("router-view"),de=Te,q=ye,ue=Ue,_e=we;return s(),d("div",Ge,[n(q,null,{default:e(()=>[n(D,{width:v.value?"64px":"240px",class:"sidebar"},{default:e(()=>[r("div",Je,[v.value?(s(),d("img",Qe)):(s(),d("img",Ke)),v.value?$("",!0):(s(),d("span",We,"实验室管理系统"))]),n(C,{"default-active":K.value,collapse:v.value,"unique-opened":!0,router:"",class:"sidebar-menu"},{default:e(()=>[(s(!0),d(E,null,R(W.value,t=>(s(),d(E,{key:t.path},[t.children&&t.children.length>1?(s(),c(M,{key:0,index:t.path},{title:e(()=>[n(o,null,{default:e(()=>[(s(),c(L(t.meta.icon)))]),_:2},1024),r("span",null,u(t.meta.title),1)]),default:e(()=>[(s(!0),d(E,null,R(t.children,x=>(s(),c(w,{key:x.path,index:T(t.path,x.path)},{default:e(()=>[p(u(x.meta.title),1)]),_:2},1032,["index"]))),128))]),_:2},1032,["index"])):t.children&&t.children.length===1?(s(),c(w,{key:1,index:T(t.path,t.children[0].path)},{title:e(()=>[p(u(t.meta.title),1)]),default:e(()=>[n(o,null,{default:e(()=>[(s(),c(L(t.meta.icon)))]),_:2},1024)]),_:2},1032,["index"])):(s(),c(w,{key:2,index:T(t.path)},{title:e(()=>[p(u(t.meta.title),1)]),default:e(()=>[n(o,null,{default:e(()=>[(s(),c(L(t.meta.icon)))]),_:2},1024)]),_:2},1032,["index"]))],64))),128))]),_:1},8,["default-active","collapse"])]),_:1},8,["width"]),n(q,null,{default:e(()=>[n(ce,{class:"header"},{default:e(()=>[r("div",Xe,[n(h,{type:"text",onClick:X,class:"collapse-btn"},{default:e(()=>[n(o,null,{default:e(()=>[v.value?(s(),c(k,{key:0})):(s(),c(_,{key:1}))]),_:1})]),_:1}),n(i,{separator:"/",class:"breadcrumb"},{default:e(()=>[(s(!0),d(E,null,R(Q.value,t=>(s(),c(b,{key:t.path,to:t.path},{default:e(()=>[p(u(t.title),1)]),_:2},1032,["to"]))),128))]),_:1})]),r("div",Ye,[n(U,{value:S.value,hidden:S.value===0},{default:e(()=>[n(h,{type:"text",onClick:ee},{default:e(()=>[n(o,null,{default:e(()=>[n(m)]),_:1})]),_:1})]),_:1},8,["value","hidden"]),n(ie,{onCommand:Y},{dropdown:e(()=>[n(le,null,{default:e(()=>[n(H,{command:"profile"},{default:e(()=>[n(o,null,{default:e(()=>[n(ae)]),_:1}),a[1]||(a[1]=p(" 个人中心 ",-1))]),_:1}),V(f).isAdmin?(s(),c(H,{key:0,command:"settings"},{default:e(()=>[n(o,null,{default:e(()=>[n(oe)]),_:1}),a[2]||(a[2]=p(" 系统设置 ",-1))]),_:1})):$("",!0),n(H,{divided:"",command:"logout"},{default:e(()=>[n(o,null,{default:e(()=>[n(se)]),_:1}),a[3]||(a[3]=p(" 退出登录 ",-1))]),_:1})]),_:1})]),default:e(()=>{var t,x;return[r("div",Ze,[n(F,{size:32,src:(t=V(f).userInfo)==null?void 0:t.avatar},{default:e(()=>{var G,J;return[p(u((J=(G=V(f).userInfo)==null?void 0:G.real_name)==null?void 0:J.charAt(0)),1)]}),_:1},8,["src"]),r("span",et,u((x=V(f).userInfo)==null?void 0:x.real_name),1),n(o,null,{default:e(()=>[n(I)]),_:1})])]}),_:1})])]),_:1}),n(de,{class:"main-content"},{default:e(()=>[n(re,null,{default:e(({Component:t})=>[n(ke,{name:"fade-transform",mode:"out-in"},{default:e(()=>[(s(),c(L(t)))]),_:2},1024)]),_:1})]),_:1})]),_:1})]),_:1}),n(_e,{modelValue:z.value,"onUpdate:modelValue":a[0]||(a[0]=t=>z.value=t),title:"系统通知",direction:"rtl",size:"400px"},{default:e(()=>[r("div",tt,[(s(!0),d(E,null,R(y.value,t=>(s(),d("div",{key:t.id,class:be(["notification-item",{unread:!t.is_read}])},[r("div",nt,[r("span",at,u(t.title),1),r("span",ot,u(ne(t.created_at)),1)]),r("div",st,u(t.content),1),r("div",lt,[t.is_read?$("",!0):(s(),c(h,{key:0,type:"text",size:"small",onClick:x=>te(t.id)},{default:e(()=>[...a[4]||(a[4]=[p(" 标记已读 ",-1)])]),_:1},8,["onClick"]))])],2))),128)),y.value.length===0?(s(),d("div",it,[n(ue,{description:"暂无通知"})])):$("",!0)])]),_:1},8,["modelValue"])])}}},Et=me(ct,[["__scopeId","data-v-9522101a"]]);export{Et as default};
