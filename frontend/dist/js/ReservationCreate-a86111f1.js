import{_ as le}from"./_plugin-vue_export-helper-383fd9f4.js";/* empty css                *//* empty css                 *//* empty css                             *//* empty css               *//* empty css                        *//* empty css                       *//* empty css                  *//* empty css               *//* empty css                             *//* empty css                  *//* empty css                  */import{u as oe,a as re,r as f,b as se,v as ne,H as ie,o as ue,c as u,d as g,f as a,w as l,a5 as de,e as b,N as pe,j as d,F as V,y as C,z as y,t as c,A as I,k as B,Q as ce,E as me,n as _e,p as fe,m as ve,a7 as ge,ap as be,a6 as ye,ay as he,l as Te,aj as De,az as ke,an as Ve,a8 as Ce,ao as Ie,h as we,aA as xe}from"./index-0407e335.js";import{checkReservationConflictApi as Ee,createReservationApi as Re}from"./reservation-e2a96893.js";import{getLabsApi as Pe,getLabByIdApi as He}from"./lab-ae8b6f89.js";import{getCoursesApi as Ae}from"./course-750d183b.js";const Ue={class:"reservation-create-container"},Ye={class:"card-header"},$e={style:{float:"right",color:"#8492a6","font-size":"13px"}},qe={key:2,class:"lab-info"},Be={__name:"ReservationCreate",setup(Fe){const w=oe(),F=re(),v=f(),h=f(!1),x=f([]),E=f([]),s=f(null),n=f(null),e=se({labId:"",reservationDate:"",startTime:"",endTime:"",purpose:"",courseId:"",expectedPeople:1,remarks:""}),D=ne(()=>F.userInfo),L={labId:[{required:!0,message:"请选择实验室",trigger:"change"}],reservationDate:[{required:!0,message:"请选择预约日期",trigger:"change"}],startTime:[{required:!0,message:"请选择开始时间",trigger:"change"}],endTime:[{required:!0,message:"请选择结束时间",trigger:"change"}],purpose:[{required:!0,message:"请输入使用目的",trigger:"blur"},{min:5,max:200,message:"使用目的长度在 5 到 200 个字符",trigger:"blur"}],expectedPeople:[{required:!0,message:"请输入预计使用人数",trigger:"blur"}]};ie(()=>[e.labId,e.reservationDate,e.startTime,e.endTime],()=>{e.labId&&e.reservationDate&&e.startTime&&e.endTime?S():n.value=null},{deep:!0});const M=async()=>{try{const r=await Pe({page:1,page_size:100});r.code===200&&(x.value=r.data.list)}catch(r){console.error("加载实验室选项失败:",r)}},N=async()=>{if(D.value.user_type==="teacher")try{const r=await Ae({page:1,page_size:100,teacher_id:D.value.id});r.code===200&&(E.value=r.data.list)}catch(r){console.error("加载课程选项失败:",r)}},z=async r=>{if(!r){s.value=null;return}try{const t=await He(r);t.code===200&&(s.value=t.data,e.expectedPeople>s.value.capacity&&(e.expectedPeople=s.value.capacity))}catch(t){console.error("获取实验室详情失败:",t)}},O=()=>{n.value=null},R=()=>{n.value=null},S=async()=>{try{const r=`${e.reservationDate} ${e.startTime}:00`,t=`${e.reservationDate} ${e.endTime}:00`;if(e.startTime>=e.endTime){n.value={hasConflict:!0,message:"结束时间必须晚于开始时间"};return}const i=await Ee({laboratory_id:e.labId,date:e.reservationDate,start_time:e.startTime,end_time:e.endTime});i.code===200&&(n.value=i.data)}catch(r){console.error("检查时间冲突失败:",r)}},j=r=>r.getTime()<Date.now()-864e5,P=()=>{const r=[];for(let t=0;t<8;t++)r.push(t);for(let t=22;t<24;t++)r.push(t);return r},H=r=>{const t=[];for(let i=0;i<60;i++)i!==0&&i!==30&&t.push(i);return t},Q=async()=>{var r;if(v.value)try{if(await v.value.validate(),(r=n.value)!=null&&r.hasConflict){B.error("存在时间冲突，请重新选择时间");return}h.value=!0;const t=`${e.reservationDate} ${e.startTime}:00`,i=`${e.reservationDate} ${e.endTime}:00`,m={laboratory_id:e.labId,reservation_date:e.reservationDate,start_time:e.startTime,end_time:e.endTime,purpose:e.purpose,participant_count:e.expectedPeople,remarks:e.remarks};e.courseId&&(m.course_id=e.courseId),(await Re(m)).code===200&&(B.success("预约提交成功，请等待审核"),w.push("/reservation/list"))}catch(t){console.error("提交预约失败:",t)}finally{h.value=!1}},G=()=>{e.labId="",e.reservationDate="",e.startTime="",e.endTime="",e.purpose="",e.courseId="",e.expectedPeople=1,e.remarks="",s.value=null,n.value=null,v.value&&v.value.clearValidate()},A=()=>{w.go(-1)};return ue(()=>{M(),N()}),(r,t)=>{const i=ce,m=me,k=_e,U=fe,p=ve,T=ge,J=be,Y=ye,$=he,q=Te,K=De,W=ke,_=Ve,X=Ce,Z=Ie,ee=we,te=de;return u(),g("div",Ue,[a(te,null,{header:l(()=>[b("div",Ye,[t[9]||(t[9]=b("span",null,"新建预约",-1)),a(m,{onClick:A},{default:l(()=>[a(i,null,{default:l(()=>[a(pe(xe))]),_:1}),t[8]||(t[8]=d(" 返回 ",-1))]),_:1})])]),default:l(()=>[a(ee,{ref_key:"reservationFormRef",ref:v,model:e,rules:L,"label-width":"120px",class:"reservation-form"},{default:l(()=>[a(Y,{gutter:20},{default:l(()=>[a(T,{span:12},{default:l(()=>[a(p,{label:"实验室",prop:"labId"},{default:l(()=>[a(U,{modelValue:e.labId,"onUpdate:modelValue":t[0]||(t[0]=o=>e.labId=o),placeholder:"请选择实验室",style:{width:"100%"},onChange:z},{default:l(()=>[(u(!0),g(V,null,C(x.value,o=>(u(),y(k,{key:o.id,label:o.name,value:o.id},{default:l(()=>[b("span",null,c(o.name),1),b("span",$e," 容量: "+c(o.capacity)+"人 ",1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(T,{span:12},{default:l(()=>[a(p,{label:"预约日期",prop:"reservationDate"},{default:l(()=>[a(J,{modelValue:e.reservationDate,"onUpdate:modelValue":t[1]||(t[1]=o=>e.reservationDate=o),type:"date",placeholder:"请选择预约日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD","disabled-date":j,style:{width:"100%"},onChange:O},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(Y,{gutter:20},{default:l(()=>[a(T,{span:12},{default:l(()=>[a(p,{label:"开始时间",prop:"startTime"},{default:l(()=>[a($,{modelValue:e.startTime,"onUpdate:modelValue":t[2]||(t[2]=o=>e.startTime=o),placeholder:"请选择开始时间",format:"HH:mm","value-format":"HH:mm","disabled-hours":P,"disabled-minutes":H,style:{width:"100%"},onChange:R},null,8,["modelValue"])]),_:1})]),_:1}),a(T,{span:12},{default:l(()=>[a(p,{label:"结束时间",prop:"endTime"},{default:l(()=>[a($,{modelValue:e.endTime,"onUpdate:modelValue":t[3]||(t[3]=o=>e.endTime=o),placeholder:"请选择结束时间",format:"HH:mm","value-format":"HH:mm","disabled-hours":P,"disabled-minutes":H,style:{width:"100%"},onChange:R},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(p,{label:"使用目的",prop:"purpose"},{default:l(()=>[a(q,{modelValue:e.purpose,"onUpdate:modelValue":t[4]||(t[4]=o=>e.purpose=o),placeholder:"请输入使用目的",clearable:""},null,8,["modelValue"])]),_:1}),D.value.user_type==="teacher"?(u(),y(p,{key:0,label:"课程",prop:"courseId"},{default:l(()=>[a(U,{modelValue:e.courseId,"onUpdate:modelValue":t[5]||(t[5]=o=>e.courseId=o),placeholder:"请选择课程（可选）",clearable:"",style:{width:"100%"}},{default:l(()=>[(u(!0),g(V,null,C(E.value,o=>(u(),y(k,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):I("",!0),a(p,{label:"预计人数",prop:"expectedPeople"},{default:l(()=>{var o;return[a(K,{modelValue:e.expectedPeople,"onUpdate:modelValue":t[6]||(t[6]=ae=>e.expectedPeople=ae),min:1,max:((o=s.value)==null?void 0:o.capacity)||100,placeholder:"请输入预计使用人数",style:{width:"100%"}},null,8,["modelValue","max"])]}),_:1}),a(p,{label:"备注"},{default:l(()=>[a(q,{modelValue:e.remarks,"onUpdate:modelValue":t[7]||(t[7]=o=>e.remarks=o),type:"textarea",rows:4,placeholder:"请输入备注信息（可选）"},null,8,["modelValue"])]),_:1}),n.value?(u(),y(W,{key:1,title:n.value.hasConflict?"时间冲突":"时间可用",type:n.value.hasConflict?"error":"success",description:n.value.message,"show-icon":"",closable:!1,class:"conflict-alert"},null,8,["title","type","description"])):I("",!0),s.value?(u(),g("div",qe,[t[10]||(t[10]=b("h4",null,"实验室信息",-1)),a(Z,{column:2,border:""},{default:l(()=>[a(_,{label:"实验室名称"},{default:l(()=>[d(c(s.value.name),1)]),_:1}),a(_,{label:"容量"},{default:l(()=>[d(c(s.value.capacity)+"人 ",1)]),_:1}),a(_,{label:"位置"},{default:l(()=>[d(c(s.value.location),1)]),_:1}),a(_,{label:"负责人"},{default:l(()=>[d(c(s.value.manager),1)]),_:1}),a(_,{label:"设备",span:2},{default:l(()=>[(u(!0),g(V,null,C(s.value.equipment,o=>(u(),y(X,{key:o.id,class:"equipment-tag"},{default:l(()=>[d(c(o.name),1)]),_:2},1024))),128))]),_:1}),a(_,{label:"描述",span:2},{default:l(()=>[d(c(s.value.description||"无"),1)]),_:1})]),_:1})])):I("",!0),a(p,null,{default:l(()=>{var o;return[a(m,{type:"primary",loading:h.value,disabled:(o=n.value)==null?void 0:o.hasConflict,onClick:Q},{default:l(()=>[d(c(h.value?"提交中...":"提交预约"),1)]),_:1},8,["loading","disabled"]),a(m,{onClick:G},{default:l(()=>[...t[11]||(t[11]=[d("重置",-1)])]),_:1}),a(m,{onClick:A},{default:l(()=>[...t[12]||(t[12]=[d("取消",-1)])]),_:1})]}),_:1})]),_:1},8,["model"])]),_:1})])}}},at=le(Be,[["__scopeId","data-v-87334f80"]]);export{at as default};
