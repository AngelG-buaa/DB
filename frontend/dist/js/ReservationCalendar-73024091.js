import{_ as ge}from"./_plugin-vue_export-helper-383fd9f4.js";/* empty css                  *//* empty css                   *//* empty css                             *//* empty css               *//* empty css                *//* empty css                     *//* empty css                  *//* empty css                        *//* empty css               *//* empty css                  *//* empty css                  *//* empty css                  */import{u as be,a as we,r as D,b as Ce,v as H,H as he,o as De,c as d,d as k,f as e,w as t,J as y,a5 as ke,x as Me,e as i,N as x,j as r,F as N,y as z,z as w,t as u,O as Ve,A as g,P as F,k as B,Q as Te,E as Ee,n as Ye,p as Re,a7 as xe,aB as Ie,a6 as Be,aC as Se,aD as Ae,au as je,an as Oe,a8 as Ue,ao as He,ae as Ne,as as ze,aA as Fe,aE as Le}from"./index-0407e335.js";import{getReservationCalendarApi as $e,getReservationStatsApi as Pe,cancelReservationApi as Ge,approveReservationApi as Je,rejectReservationApi as Qe}from"./reservation-e2a96893.js";import{getLabsApi as qe}from"./lab-ae8b6f89.js";const Ke={class:"reservation-calendar-container"},We={class:"card-header"},Xe={class:"header-actions"},Ze={class:"filter-section"},ea={class:"calendar-section"},aa={class:"calendar-header"},ta={class:"current-date"},la={class:"calendar-cell"},sa={class:"cell-date"},oa={class:"cell-reservations"},na=["onClick"],ra={class:"reservation-time"},ua={class:"reservation-lab"},da={key:0,class:"reservation-user"},ia={class:"stats-section"},ca={key:0,class:"reservation-detail"},pa={class:"detail-actions"},_a={__name:"ReservationCalendar",setup(va){const S=be(),L=we(),p=D(new Date),T=D(!1),s=D(null),A=D([]),j=D([]),M=D({total:0,pending:0,approved:0,thisMonth:0}),o=Ce({labId:"",status:"",viewType:"month",onlyMine:!1}),h=H(()=>L.userInfo),$=H(()=>{const a=y(p.value).startOf(o.viewType),l=y(p.value).endOf(o.viewType);return[a.toDate(),l.toDate()]}),P=async()=>{try{const a=await qe({page:1,page_size:100});a.code===200&&(A.value=a.data.list)}catch(a){console.error("加载实验室选项失败:",a)}},f=async()=>{try{const a=y(p.value).startOf(o.viewType).format("YYYY-MM-DD"),l=y(p.value).endOf(o.viewType).format("YYYY-MM-DD"),c={start_date:a,end_date:l};o.labId&&(c.lab_id=o.labId),o.status&&(c.status=o.status),o.onlyMine&&(c.user_id=h.value.id);const _=await $e(c);_.code===200&&(j.value=_.data)}catch(a){console.error("加载日历数据失败:",a)}},V=async()=>{try{const a={};o.onlyMine&&(a.user_id=h.value.id);const l=await Pe(a);l.code===200&&(M.value=l.data)}catch(a){console.error("加载统计数据失败:",a)}},G=a=>j.value.filter(l=>y(l.start_time).format("YYYY-MM-DD")===a),J=a=>{s.value=a,T.value=!0},E=()=>{T.value=!1,s.value=null},Q=()=>{f()},q=()=>{p.value=y(p.value).subtract(1,o.viewType).toDate()},K=()=>{p.value=y(p.value).add(1,o.viewType).toDate()},W=()=>{p.value=new Date},X=()=>{S.push("/reservation/create")},Z=()=>{f(),V()},ee=()=>{S.push(`/reservation/edit/${s.value.id}`)},ae=async()=>{try{await F.confirm("确定要取消这个预约吗？","确认取消",{type:"warning"}),(await Ge(s.value.id)).code===200&&(B.success("预约已取消"),E(),f(),V())}catch(a){a!=="cancel"&&console.error("取消预约失败:",a)}},te=async()=>{try{(await Je(s.value.id)).code===200&&(B.success("预约已通过"),E(),f(),V())}catch(a){console.error("通过预约失败:",a)}},le=async()=>{try{const{value:a}=await F.prompt("请输入拒绝原因","拒绝预约",{confirmButtonText:"确定",cancelButtonText:"取消",inputValidator:c=>!c||c.trim().length<5?"拒绝原因不能少于5个字符":!0});(await Qe(s.value.id,{reason:a})).code===200&&(B.success("预约已拒绝"),E(),f(),V())}catch(a){a!=="cancel"&&console.error("拒绝预约失败:",a)}},se=a=>a.user_id===h.value.id&&["pending","approved"].includes(a.status),oe=a=>a.user_id===h.value.id&&["pending","approved"].includes(a.status),ne=a=>["admin","teacher"].includes(h.value.user_type)&&a.status==="pending",re=a=>["admin","teacher"].includes(h.value.user_type)&&a.status==="pending",ue=a=>y(a).format("YYYY年MM月"),O=a=>y(a).format("HH:mm"),Y=a=>y(a).format("YYYY-MM-DD HH:mm"),de=a=>({pending:"warning",approved:"success",rejected:"danger",cancelled:"info",completed:"success"})[a]||"info",ie=a=>({pending:"待审核",approved:"已通过",rejected:"已拒绝",cancelled:"已取消",completed:"已完成"})[a]||a;return he(p,()=>{f()}),De(()=>{P(),f(),V()}),(a,l)=>{const c=Te,_=Ee,m=Ye,I=Re,b=xe,ce=Ie,U=Be,pe=Se,_e=Ae,R=je,ve=ke,v=Oe,me=Ue,fe=He,ye=Me;return d(),k("div",Ke,[e(ve,null,{header:t(()=>[i("div",We,[l[8]||(l[8]=i("span",null,"预约日历",-1)),i("div",Xe,[e(_,{type:"primary",onClick:X},{default:t(()=>[e(c,null,{default:t(()=>[e(x(Ne))]),_:1}),l[6]||(l[6]=r(" 新建预约 ",-1))]),_:1}),e(_,{onClick:Z},{default:t(()=>[e(c,null,{default:t(()=>[e(x(ze))]),_:1}),l[7]||(l[7]=r(" 刷新 ",-1))]),_:1})])])]),default:t(()=>[i("div",Ze,[e(U,{gutter:20},{default:t(()=>[e(b,{span:6},{default:t(()=>[e(I,{modelValue:o.labId,"onUpdate:modelValue":l[0]||(l[0]=n=>o.labId=n),placeholder:"选择实验室",clearable:"",onChange:f},{default:t(()=>[e(m,{label:"全部实验室",value:""}),(d(!0),k(N,null,z(A.value,n=>(d(),w(m,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(b,{span:6},{default:t(()=>[e(I,{modelValue:o.status,"onUpdate:modelValue":l[1]||(l[1]=n=>o.status=n),placeholder:"预约状态",clearable:"",onChange:f},{default:t(()=>[e(m,{label:"全部状态",value:""}),e(m,{label:"待审核",value:"pending"}),e(m,{label:"已通过",value:"approved"}),e(m,{label:"已拒绝",value:"rejected"}),e(m,{label:"已取消",value:"cancelled"}),e(m,{label:"已完成",value:"completed"})]),_:1},8,["modelValue"])]),_:1}),e(b,{span:6},{default:t(()=>[e(I,{modelValue:o.viewType,"onUpdate:modelValue":l[2]||(l[2]=n=>o.viewType=n),onChange:Q},{default:t(()=>[e(m,{label:"月视图",value:"month"}),e(m,{label:"周视图",value:"week"}),e(m,{label:"日视图",value:"day"})]),_:1},8,["modelValue"])]),_:1}),e(b,{span:6},{default:t(()=>[e(ce,{modelValue:o.onlyMine,"onUpdate:modelValue":l[3]||(l[3]=n=>o.onlyMine=n),"active-text":"仅我的预约",onChange:f},null,8,["modelValue"])]),_:1})]),_:1})]),i("div",ea,[e(_e,{modelValue:p.value,"onUpdate:modelValue":l[4]||(l[4]=n=>p.value=n),range:$.value,class:"reservation-calendar"},{header:t(({date:n})=>[i("div",aa,[e(pe,null,{default:t(()=>[e(_,{onClick:q},{default:t(()=>[e(c,null,{default:t(()=>[e(x(Fe))]),_:1})]),_:1}),e(_,{onClick:W},{default:t(()=>[...l[9]||(l[9]=[r("今天",-1)])]),_:1}),e(_,{onClick:K},{default:t(()=>[e(c,null,{default:t(()=>[e(x(Le))]),_:1})]),_:1})]),_:1}),i("span",ta,u(ue(n)),1)])]),"date-cell":t(({data:n})=>[i("div",la,[i("div",sa,u(n.day.split("-").slice(-1)[0]),1),i("div",oa,[(d(!0),k(N,null,z(G(n.day),C=>(d(),k("div",{key:C.id,class:Ve(["reservation-item",`status-${C.status}`]),onClick:ma=>J(C)},[i("div",ra,u(O(C.start_time))+"-"+u(O(C.end_time)),1),i("div",ua,u(C.lab_name),1),o.onlyMine?g("",!0):(d(),k("div",da,u(C.user_name),1))],10,na))),128))])])]),_:1},8,["modelValue","range"])]),i("div",ia,[e(U,{gutter:20},{default:t(()=>[e(b,{span:6},{default:t(()=>[e(R,{title:"总预约数",value:M.value.total},null,8,["value"])]),_:1}),e(b,{span:6},{default:t(()=>[e(R,{title:"待审核",value:M.value.pending},null,8,["value"])]),_:1}),e(b,{span:6},{default:t(()=>[e(R,{title:"已通过",value:M.value.approved},null,8,["value"])]),_:1}),e(b,{span:6},{default:t(()=>[e(R,{title:"本月预约",value:M.value.thisMonth},null,8,["value"])]),_:1})]),_:1})])]),_:1}),e(ye,{modelValue:T.value,"onUpdate:modelValue":l[5]||(l[5]=n=>T.value=n),title:"预约详情",width:"600px","before-close":E},{default:t(()=>[s.value?(d(),k("div",ca,[e(fe,{column:2,border:""},{default:t(()=>[e(v,{label:"预约ID"},{default:t(()=>[r(u(s.value.id),1)]),_:1}),e(v,{label:"状态"},{default:t(()=>[e(me,{type:de(s.value.status)},{default:t(()=>[r(u(ie(s.value.status)),1)]),_:1},8,["type"])]),_:1}),e(v,{label:"实验室"},{default:t(()=>[r(u(s.value.lab_name),1)]),_:1}),e(v,{label:"预约人"},{default:t(()=>[r(u(s.value.user_name),1)]),_:1}),e(v,{label:"开始时间"},{default:t(()=>[r(u(Y(s.value.start_time)),1)]),_:1}),e(v,{label:"结束时间"},{default:t(()=>[r(u(Y(s.value.end_time)),1)]),_:1}),e(v,{label:"使用目的",span:2},{default:t(()=>[r(u(s.value.purpose),1)]),_:1}),e(v,{label:"预计人数"},{default:t(()=>[r(u(s.value.expected_people)+"人 ",1)]),_:1}),s.value.course_name?(d(),w(v,{key:0,label:"课程"},{default:t(()=>[r(u(s.value.course_name),1)]),_:1})):g("",!0),s.value.remarks?(d(),w(v,{key:1,label:"备注",span:2},{default:t(()=>[r(u(s.value.remarks),1)]),_:1})):g("",!0),e(v,{label:"创建时间"},{default:t(()=>[r(u(Y(s.value.created_at)),1)]),_:1}),s.value.reviewed_at?(d(),w(v,{key:2,label:"审核时间"},{default:t(()=>[r(u(Y(s.value.reviewed_at)),1)]),_:1})):g("",!0)]),_:1}),i("div",pa,[se(s.value)?(d(),w(_,{key:0,type:"primary",onClick:ee},{default:t(()=>[...l[10]||(l[10]=[r(" 编辑 ",-1)])]),_:1})):g("",!0),oe(s.value)?(d(),w(_,{key:1,type:"warning",onClick:ae},{default:t(()=>[...l[11]||(l[11]=[r(" 取消预约 ",-1)])]),_:1})):g("",!0),ne(s.value)?(d(),w(_,{key:2,type:"success",onClick:te},{default:t(()=>[...l[12]||(l[12]=[r(" 通过 ",-1)])]),_:1})):g("",!0),re(s.value)?(d(),w(_,{key:3,type:"danger",onClick:le},{default:t(()=>[...l[13]||(l[13]=[r(" 拒绝 ",-1)])]),_:1})):g("",!0)])])):g("",!0)]),_:1},8,["modelValue"])])}}},Ia=ge(_a,[["__scopeId","data-v-cdd9084a"]]);export{Ia as default};
