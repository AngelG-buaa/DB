import{_ as Te}from"./_plugin-vue_export-helper-383fd9f4.js";/* empty css                   *//* empty css                             *//* empty css                  *//* empty css                   *//* empty css                 *//* empty css                        *//* empty css                      *//* empty css               *//* empty css                  *//* empty css                  *//* empty css                        *//* empty css                    */import"./el-tooltip-4ed993c7.js";/* empty css                *//* empty css                *//* empty css                     *//* empty css               *//* empty css                             *//* empty css                  */import{u as $e,a as Be,r as y,b as A,J as b,v as se,o as Fe,c as m,d as w,f as e,w as a,a5 as Le,x as Ae,e as V,z as k,N as P,j as i,A as U,g as Pe,F as ie,y as re,ai as Ne,t as r,O as de,P as ue,k as N,Q as Oe,E as je,l as He,a7 as Ke,n as Je,p as Qe,ap as Ge,a6 as We,au as Xe,ak as Ze,s as et,a8 as tt,al as at,am as lt,m as ot,aj as nt,h as st,an as it,ao as rt,aq as dt,ae as ut,ar as pe,as as pt}from"./index-0407e335.js";import{g as ct,a as mt,b as _t,u as ce,c as ft,d as gt}from"./maintenance-0ef2aad3.js";import{g as vt}from"./equipment-16832688.js";const yt={class:"maintenance-list-container"},bt={class:"card-header"},Dt={class:"search-section"},Vt={class:"stats-section"},Yt={class:"equipment-model"},kt={key:0},ht={key:1,class:"no-cost"},Ct={class:"pagination-section"},Mt={key:0,class:"maintenance-detail"},xt={__name:"MaintenanceList",setup(wt){const me=$e(),_e=Be(),O=y(!1),q=y(!1),h=y(!1),j=y(!1),C=y(!1),H=y([]),d=y(null),S=y([]),E=y(),s=A({keyword:"",equipmentId:"",type:"",status:"",dateRange:[]}),c=A({page:1,size:20,total:0}),I=A({total:0,inProgress:0,thisMonth:0,totalCost:0}),n=A({id:null,equipmentId:"",type:"maintenance",description:"",technician:"",cost:0,startDate:b().format("YYYY-MM-DD"),expectedCompletionDate:"",actualCompletionDate:"",status:"in_progress",remarks:""}),fe=se(()=>_e.userInfo),ge=se(()=>C.value?"编辑维修记录":"新建维修记录"),ve={equipmentId:[{required:!0,message:"请选择设备",trigger:"change"}],type:[{required:!0,message:"请选择维修类型",trigger:"change"}],description:[{required:!0,message:"请输入问题描述",trigger:"blur"},{min:10,max:500,message:"描述长度在 10 到 500 个字符",trigger:"blur"}],technician:[{required:!0,message:"请输入维修人员姓名",trigger:"blur"},{min:2,max:20,message:"姓名长度在 2 到 20 个字符",trigger:"blur"}],startDate:[{required:!0,message:"请选择开始日期",trigger:"change"}],expectedCompletionDate:[{required:!0,message:"请选择预计完成日期",trigger:"change"}],status:[{required:!0,message:"请选择状态",trigger:"change"}]},K=o=>{var t;return o.includes((t=fe.value)==null?void 0:t.role)},ye=async()=>{try{const o=await vt({page:1,page_size:1e3});o.code===200&&(S.value=o.data.list)}catch(o){console.error("加载设备选项失败:",o)}},T=async()=>{try{const o=await ct();o.code===200&&Object.assign(I,o.data)}catch(o){console.error("加载统计数据失败:",o)}},D=async()=>{O.value=!0;try{const o={page:c.page,size:c.size};s.keyword&&(o.keyword=s.keyword),s.equipmentId&&(o.equipment_id=s.equipmentId),s.type&&(o.type=s.type),s.status&&(o.status=s.status),s.dateRange&&s.dateRange.length===2&&(o.start_date=s.dateRange[0],o.end_date=s.dateRange[1]);const t=await mt(o);t.code===200&&(H.value=t.data.list,c.total=t.data.total)}catch(o){console.error("加载维修记录失败:",o)}finally{O.value=!1}},J=()=>{c.page=1,D()},be=()=>{s.keyword="",s.equipmentId="",s.type="",s.status="",s.dateRange=[],c.page=1,D()},De=o=>{c.size=o,c.page=1,D()},Ve=o=>{c.page=o,D()},Ye=()=>{C.value=!1,G(),h.value=!0},ke=o=>{C.value=!0,Object.assign(n,{id:o.id,equipmentId:o.equipment_id,type:o.type,description:o.description,technician:o.technician,cost:o.cost,startDate:o.start_date,expectedCompletionDate:o.expected_completion_date,actualCompletionDate:o.actual_completion_date,status:o.status,remarks:o.remarks}),h.value=!0},he=async o=>{try{const t=await _t(o.id);t.code===200&&(d.value=t.data,j.value=!0)}catch(t){console.error("获取维修记录详情失败:",t)}},Ce=async o=>{try{await ue.confirm("确定要标记此维修记录为已完成吗？","确认完成",{type:"success"});const t={status:"completed",actual_completion_date:b().format("YYYY-MM-DD")};(await ce(o.id,t)).code===200&&(N.success("维修记录已标记为完成"),D(),T())}catch(t){t!=="cancel"&&console.error("完成维修记录失败:",t)}},Me=o=>{me.push(`/equipment?id=${o}`)},xe=async()=>{if(E.value)try{if(await E.value.validate(),q.value=!0,n.expectedCompletionDate&&n.startDate&&b(n.expectedCompletionDate).isBefore(b(n.startDate))){N.error("预计完成日期不能早于开始日期"),q.value=!1;return}const o=S.value.find(_=>_.id===n.equipmentId),t={equipment_id:n.equipmentId,laboratory_id:o==null?void 0:o.laboratory_id,type:n.type,description:n.description,technician:n.technician,cost:n.cost,start_date:n.startDate,expected_completion_date:n.expectedCompletionDate,status:n.status,remarks:n.remarks};n.actualCompletionDate&&(t.actual_completion_date=n.actualCompletionDate);const Y=C.value?ce:ft,f=C.value?[n.id,t]:[t];(await Y(...f)).code===200&&(N.success(C.value?"更新成功":"创建成功"),h.value=!1,D(),T())}catch(o){console.error("提交失败:",o)}finally{q.value=!1}},we=async o=>{try{await ue.confirm("确定要删除这条维修记录吗？此操作不可恢复。","确认删除",{type:"warning"}),(await gt(o.id)).code===200&&(N.success("删除成功"),D(),T())}catch(t){t!=="cancel"&&console.error("删除失败:",t)}},Q=()=>{h.value=!1,G()},G=()=>{n.id=null,n.equipmentId="",n.type="maintenance",n.description="",n.technician="",n.cost=0,n.startDate=b().format("YYYY-MM-DD"),n.expectedCompletionDate="",n.actualCompletionDate="",n.status="in_progress",n.remarks="",E.value&&E.value.clearValidate()},W=o=>b(o).format("YYYY-MM-DD HH:mm"),M=o=>b(o).format("YYYY-MM-DD"),X=o=>Number(o).toLocaleString(),Z=o=>o.status==="in_progress"&&b(o.expected_completion_date).isBefore(b()),ee=o=>({maintenance:"success",repair:"warning",upgrade:"primary"})[o]||"info",te=o=>({maintenance:"定期保养",repair:"故障维修",upgrade:"升级改造"})[o]||o,ae=o=>({in_progress:"warning",completed:"success",cancelled:"info"})[o]||"info",le=o=>({in_progress:"进行中",completed:"已完成",cancelled:"已取消"})[o]||o;return Fe(()=>{ye(),D(),T()}),(o,t)=>{const Y=Oe,f=je,R=He,_=Ke,u=Je,x=Qe,$=Ge,oe=We,B=Xe,z=Le,g=Ze,qe=et,F=tt,Ee=at,Ie=lt,v=ot,Re=nt,ze=st,ne=Ae,p=it,Ue=rt,Se=dt;return m(),w("div",yt,[e(z,null,{header:a(()=>[V("div",bt,[t[20]||(t[20]=V("span",null,"设备维修记录",-1)),K(["admin","teacher"])?(m(),k(f,{key:0,type:"primary",onClick:Ye},{default:a(()=>[e(Y,null,{default:a(()=>[e(P(ut))]),_:1}),t[19]||(t[19]=i(" 新建维修记录 ",-1))]),_:1})):U("",!0)])]),default:a(()=>[V("div",Dt,[e(oe,{gutter:20},{default:a(()=>[e(_,{span:5},{default:a(()=>[e(R,{modelValue:s.keyword,"onUpdate:modelValue":t[0]||(t[0]=l=>s.keyword=l),placeholder:"搜索设备名称或维修人员",clearable:"",onKeyup:Pe(J,["enter"])},{prefix:a(()=>[e(Y,null,{default:a(()=>[e(P(pe))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(_,{span:4},{default:a(()=>[e(x,{modelValue:s.equipmentId,"onUpdate:modelValue":t[1]||(t[1]=l=>s.equipmentId=l),placeholder:"选择设备",clearable:"",filterable:""},{default:a(()=>[e(u,{label:"全部设备",value:""}),(m(!0),w(ie,null,re(S.value,l=>(m(),k(u,{key:l.id,label:`${l.name} (${l.model})`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(_,{span:3},{default:a(()=>[e(x,{modelValue:s.type,"onUpdate:modelValue":t[2]||(t[2]=l=>s.type=l),placeholder:"维修类型",clearable:""},{default:a(()=>[e(u,{label:"全部类型",value:""}),e(u,{label:"定期保养",value:"maintenance"}),e(u,{label:"故障维修",value:"repair"}),e(u,{label:"升级改造",value:"upgrade"})]),_:1},8,["modelValue"])]),_:1}),e(_,{span:3},{default:a(()=>[e(x,{modelValue:s.status,"onUpdate:modelValue":t[3]||(t[3]=l=>s.status=l),placeholder:"维修状态",clearable:""},{default:a(()=>[e(u,{label:"全部状态",value:""}),e(u,{label:"进行中",value:"in_progress"}),e(u,{label:"已完成",value:"completed"}),e(u,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),_:1}),e(_,{span:4},{default:a(()=>[e($,{modelValue:s.dateRange,"onUpdate:modelValue":t[4]||(t[4]=l=>s.dateRange=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),e(_,{span:5},{default:a(()=>[e(f,{type:"primary",onClick:J},{default:a(()=>[e(Y,null,{default:a(()=>[e(P(pe))]),_:1}),t[21]||(t[21]=i(" 搜索 ",-1))]),_:1}),e(f,{onClick:be},{default:a(()=>[e(Y,null,{default:a(()=>[e(P(pt))]),_:1}),t[22]||(t[22]=i(" 重置 ",-1))]),_:1})]),_:1})]),_:1})]),V("div",Vt,[e(oe,{gutter:20},{default:a(()=>[e(_,{span:6},{default:a(()=>[e(z,{class:"stat-card"},{default:a(()=>[e(B,{title:"总维修记录",value:I.total},null,8,["value"])]),_:1})]),_:1}),e(_,{span:6},{default:a(()=>[e(z,{class:"stat-card"},{default:a(()=>[e(B,{title:"进行中",value:I.inProgress},null,8,["value"])]),_:1})]),_:1}),e(_,{span:6},{default:a(()=>[e(z,{class:"stat-card"},{default:a(()=>[e(B,{title:"本月完成",value:I.thisMonth},null,8,["value"])]),_:1})]),_:1}),e(_,{span:6},{default:a(()=>[e(z,{class:"stat-card"},{default:a(()=>[e(B,{title:"总费用",value:I.totalCost,prefix:"¥"},null,8,["value"])]),_:1})]),_:1})]),_:1})]),Ne((m(),k(Ee,{data:H.value,stripe:"",class:"maintenance-table"},{default:a(()=>[e(g,{prop:"id",label:"ID",width:"80"}),e(g,{prop:"equipment_name",label:"设备名称","min-width":"150"},{default:a(({row:l})=>[e(qe,{type:"primary",onClick:L=>Me(l.equipment_id)},{default:a(()=>[i(r(l.equipment_name),1)]),_:2},1032,["onClick"]),V("div",Yt,r(l.equipment_model),1)]),_:1}),e(g,{prop:"type",label:"维修类型",width:"100"},{default:a(({row:l})=>[e(F,{type:ee(l.type)},{default:a(()=>[i(r(te(l.type)),1)]),_:2},1032,["type"])]),_:1}),e(g,{prop:"status",label:"状态",width:"100"},{default:a(({row:l})=>[e(F,{type:ae(l.status)},{default:a(()=>[i(r(le(l.status)),1)]),_:2},1032,["type"])]),_:1}),e(g,{prop:"technician",label:"维修人员",width:"100"}),e(g,{prop:"cost",label:"费用",width:"100"},{default:a(({row:l})=>[l.cost>0?(m(),w("span",kt,"¥"+r(X(l.cost)),1)):(m(),w("span",ht,"-"))]),_:1}),e(g,{prop:"start_date",label:"开始日期",width:"120"},{default:a(({row:l})=>[i(r(M(l.start_date)),1)]),_:1}),e(g,{prop:"expected_completion_date",label:"预计完成",width:"120"},{default:a(({row:l})=>[V("span",{class:de({overdue:Z(l)})},r(M(l.expected_completion_date)),3)]),_:1}),e(g,{prop:"actual_completion_date",label:"实际完成",width:"120"},{default:a(({row:l})=>[i(r(l.actual_completion_date?M(l.actual_completion_date):"-"),1)]),_:1}),e(g,{prop:"description",label:"问题描述","min-width":"200","show-overflow-tooltip":""}),K(["admin","teacher"])?(m(),k(g,{key:0,label:"操作",width:"180",fixed:"right"},{default:a(({row:l})=>[e(f,{type:"primary",size:"small",onClick:L=>he(l)},{default:a(()=>[...t[23]||(t[23]=[i(" 详情 ",-1)])]),_:1},8,["onClick"]),l.status==="in_progress"?(m(),k(f,{key:0,type:"success",size:"small",onClick:L=>Ce(l)},{default:a(()=>[...t[24]||(t[24]=[i(" 完成 ",-1)])]),_:1},8,["onClick"])):U("",!0),e(f,{type:"warning",size:"small",onClick:L=>ke(l)},{default:a(()=>[...t[25]||(t[25]=[i(" 编辑 ",-1)])]),_:1},8,["onClick"]),e(f,{type:"danger",size:"small",onClick:L=>we(l)},{default:a(()=>[...t[26]||(t[26]=[i(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})):U("",!0)]),_:1},8,["data"])),[[Se,O.value]]),V("div",Ct,[e(Ie,{"current-page":c.page,"onUpdate:currentPage":t[5]||(t[5]=l=>c.page=l),"page-size":c.size,"onUpdate:pageSize":t[6]||(t[6]=l=>c.size=l),total:c.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:De,onCurrentChange:Ve},null,8,["current-page","page-size","total"])])]),_:1}),e(ne,{modelValue:h.value,"onUpdate:modelValue":t[17]||(t[17]=l=>h.value=l),title:ge.value,width:"600px","before-close":Q},{footer:a(()=>[e(f,{onClick:Q},{default:a(()=>[...t[27]||(t[27]=[i("取消",-1)])]),_:1}),e(f,{type:"primary",loading:q.value,onClick:xe},{default:a(()=>[i(r(q.value?"提交中...":"确定"),1)]),_:1},8,["loading"])]),default:a(()=>[e(ze,{ref_key:"maintenanceFormRef",ref:E,model:n,rules:ve,"label-width":"120px"},{default:a(()=>[e(v,{label:"设备",prop:"equipmentId"},{default:a(()=>[e(x,{modelValue:n.equipmentId,"onUpdate:modelValue":t[7]||(t[7]=l=>n.equipmentId=l),placeholder:"请选择设备",filterable:"",style:{width:"100%"}},{default:a(()=>[(m(!0),w(ie,null,re(S.value,l=>(m(),k(u,{key:l.id,label:`${l.name} (${l.model})`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(v,{label:"维修类型",prop:"type"},{default:a(()=>[e(x,{modelValue:n.type,"onUpdate:modelValue":t[8]||(t[8]=l=>n.type=l),style:{width:"100%"}},{default:a(()=>[e(u,{label:"定期保养",value:"maintenance"}),e(u,{label:"故障维修",value:"repair"}),e(u,{label:"升级改造",value:"upgrade"})]),_:1},8,["modelValue"])]),_:1}),e(v,{label:"问题描述",prop:"description"},{default:a(()=>[e(R,{modelValue:n.description,"onUpdate:modelValue":t[9]||(t[9]=l=>n.description=l),type:"textarea",rows:4,placeholder:"请详细描述设备问题或维修内容"},null,8,["modelValue"])]),_:1}),e(v,{label:"维修人员",prop:"technician"},{default:a(()=>[e(R,{modelValue:n.technician,"onUpdate:modelValue":t[10]||(t[10]=l=>n.technician=l),placeholder:"请输入维修人员姓名",clearable:""},null,8,["modelValue"])]),_:1}),e(v,{label:"维修费用"},{default:a(()=>[e(Re,{modelValue:n.cost,"onUpdate:modelValue":t[11]||(t[11]=l=>n.cost=l),min:0,precision:2,placeholder:"请输入维修费用",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),e(v,{label:"开始日期",prop:"startDate"},{default:a(()=>[e($,{modelValue:n.startDate,"onUpdate:modelValue":t[12]||(t[12]=l=>n.startDate=l),type:"date",placeholder:"请选择开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),e(v,{label:"预计完成日期",prop:"expectedCompletionDate"},{default:a(()=>[e($,{modelValue:n.expectedCompletionDate,"onUpdate:modelValue":t[13]||(t[13]=l=>n.expectedCompletionDate=l),type:"date",placeholder:"请选择预计完成日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),e(v,{label:"状态",prop:"status"},{default:a(()=>[e(x,{modelValue:n.status,"onUpdate:modelValue":t[14]||(t[14]=l=>n.status=l),style:{width:"100%"}},{default:a(()=>[e(u,{label:"进行中",value:"in_progress"}),e(u,{label:"已完成",value:"completed"}),e(u,{label:"已取消",value:"cancelled"})]),_:1},8,["modelValue"])]),_:1}),n.status==="completed"?(m(),k(v,{key:0,label:"实际完成日期"},{default:a(()=>[e($,{modelValue:n.actualCompletionDate,"onUpdate:modelValue":t[15]||(t[15]=l=>n.actualCompletionDate=l),type:"date",placeholder:"请选择实际完成日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})):U("",!0),e(v,{label:"备注"},{default:a(()=>[e(R,{modelValue:n.remarks,"onUpdate:modelValue":t[16]||(t[16]=l=>n.remarks=l),type:"textarea",rows:3,placeholder:"请输入备注信息（可选）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(ne,{modelValue:j.value,"onUpdate:modelValue":t[18]||(t[18]=l=>j.value=l),title:"维修记录详情",width:"700px"},{default:a(()=>[d.value?(m(),w("div",Mt,[e(Ue,{column:2,border:""},{default:a(()=>[e(p,{label:"记录ID"},{default:a(()=>[i(r(d.value.id),1)]),_:1}),e(p,{label:"设备"},{default:a(()=>[i(r(d.value.equipment_name)+" ("+r(d.value.equipment_model)+") ",1)]),_:1}),e(p,{label:"维修类型"},{default:a(()=>[e(F,{type:ee(d.value.type)},{default:a(()=>[i(r(te(d.value.type)),1)]),_:1},8,["type"])]),_:1}),e(p,{label:"状态"},{default:a(()=>[e(F,{type:ae(d.value.status)},{default:a(()=>[i(r(le(d.value.status)),1)]),_:1},8,["type"])]),_:1}),e(p,{label:"维修人员"},{default:a(()=>[i(r(d.value.technician),1)]),_:1}),e(p,{label:"费用"},{default:a(()=>[i(r(d.value.cost>0?`¥${X(d.value.cost)}`:"无"),1)]),_:1}),e(p,{label:"开始日期"},{default:a(()=>[i(r(M(d.value.start_date)),1)]),_:1}),e(p,{label:"预计完成日期"},{default:a(()=>[V("span",{class:de({overdue:Z(d.value)})},r(M(d.value.expected_completion_date)),3)]),_:1}),e(p,{label:"实际完成日期"},{default:a(()=>[i(r(d.value.actual_completion_date?M(d.value.actual_completion_date):"未完成"),1)]),_:1}),e(p,{label:"创建人"},{default:a(()=>[i(r(d.value.created_by_name),1)]),_:1}),e(p,{label:"问题描述",span:2},{default:a(()=>[i(r(d.value.description),1)]),_:1}),e(p,{label:"备注",span:2},{default:a(()=>[i(r(d.value.remarks||"无"),1)]),_:1}),e(p,{label:"创建时间"},{default:a(()=>[i(r(W(d.value.created_at)),1)]),_:1}),e(p,{label:"更新时间"},{default:a(()=>[i(r(W(d.value.updated_at)),1)]),_:1})]),_:1})])):U("",!0)]),_:1},8,["modelValue"])])}}},Xt=Te(xt,[["__scopeId","data-v-69968a61"]]);export{Xt as default};
